(function(n){n.jgrid.extend({setTreeNode:function(t,i){return this.each(function(){var r=this,l,a,o,h,c,u;if(r.grid&&r.p.treeGrid){var v=r.p.expColInd,e=r.p.treeReader.expanded_field,f=r.p.treeReader.leaf_field,s=r.p.treeReader.level_field;i.level=t[s];r.p.treeGridModel=="nested"&&(l=t[r.p.treeReader.left_field],a=t[r.p.treeReader.right_field],t[f]||(t[f]=parseInt(a,10)===parseInt(l,10)+1?"true":"false"));o=parseInt(t[s],10);r.p.tree_root_level===0?(h=o+1,c=o):(h=o,c=o-1);u="<div class='tree-wrap tree-wrap-"+r.p.direction+"' style='width:"+h*18+"px;'>";u+="<div style='"+(r.p.direction=="rtl"?"right:":"left:")+c*18+"px;' class='ui-icon ";t[f]=="true"||t[f]===!0?(u+=r.p.treeIcons.leaf+" tree-leaf'",t[f]=!0,t[e]=!1):(t[e]=="true"||t[e]===!0?(u+=r.p.treeIcons.minus+" tree-minus treeclick'",t[e]=!0):(u+=r.p.treeIcons.plus+" tree-plus treeclick'",t[e]=!1),t[f]=!1);u+="<\/div><\/div>";r.p.loadonce||(t[r.p.localReader.id]=i.id,r.p.data.push(t),r.p._index[i.id]=r.p.data.length-1);parseInt(t[s],10)!==parseInt(r.p.tree_root_level,10)&&(n(r).jqGrid("isVisibleNode",t)||n(i).css("display","none"));n("td:eq("+v+")",i).wrapInner("<span><\/span>").prepend(u);n(".treeclick",i).bind("click",function(t){var u=t.target||t.srcElement,f=n(u,r.rows).closest("tr.jqgrow")[0].id,i=r.p._index[f],e=r.p.treeReader.leaf_field,o=r.p.treeReader.expanded_field;return r.p.data[i][e]||(r.p.data[i][o]?(n(r).jqGrid("collapseRow",r.p.data[i]),n(r).jqGrid("collapseNode",r.p.data[i])):(n(r).jqGrid("expandRow",r.p.data[i]),n(r).jqGrid("expandNode",r.p.data[i]))),!1});r.p.ExpandColClick===!0&&n("span",i).css("cursor","pointer").bind("click",function(t){var f=t.target||t.srcElement,u=n(f,r.rows).closest("tr.jqgrow")[0].id,i=r.p._index[u],e=r.p.treeReader.leaf_field,o=r.p.treeReader.expanded_field;return r.p.data[i][e]||(r.p.data[i][o]?(n(r).jqGrid("collapseRow",r.p.data[i]),n(r).jqGrid("collapseNode",r.p.data[i])):(n(r).jqGrid("expandRow",r.p.data[i]),n(r).jqGrid("expandNode",r.p.data[i]))),n(r).jqGrid("setSelection",u),!1})}})},setTreeGrid:function(){return this.each(function(){var t=this,r=0,u,i;if(t.p.treeGrid){t.p.treedatatype||n.extend(t.p,{treedatatype:t.p.datatype});t.p.subGrid=!1;t.p.altRows=!1;t.p.pgbuttons=!1;t.p.pginput=!1;t.p.multiselect=!1;t.p.rowList=[];u="ui-icon-triangle-1-"+(t.p.direction=="rtl"?"w":"e");t.p.treeIcons=n.extend({plus:u,minus:"ui-icon-triangle-1-s",leaf:"ui-icon-radio-off"},t.p.treeIcons||{});t.p.treeGridModel=="nested"?t.p.treeReader=n.extend({level_field:"level",left_field:"lft",right_field:"rgt",leaf_field:"isLeaf",expanded_field:"expanded"},t.p.treeReader):t.p.treeGridModel=="adjacency"&&(t.p.treeReader=n.extend({level_field:"level",parent_id_field:"parent",leaf_field:"isLeaf",expanded_field:"expanded"},t.p.treeReader));for(i in t.p.colModel)if(t.p.colModel.hasOwnProperty(i)){if(t.p.colModel[i].name==t.p.ExpandColumn){t.p.expColInd=r;break}r++}t.p.expColInd||(t.p.expColInd=0);n.each(t.p.treeReader,function(n,i){i&&(t.p.colNames.push(i),t.p.colModel.push({name:i,width:1,hidden:!0,sortable:!1,resizable:!1,hidedlg:!0,editable:!0,search:!1}))})}})},expandRow:function(t){this.each(function(){var i=this,r,u;i.grid&&i.p.treeGrid&&(r=n(i).jqGrid("getNodeChildren",t),u=i.p.treeReader.expanded_field,n(r).each(function(){var t=n.jgrid.getAccessor(this,i.p.localReader.id);n("#"+t,i.grid.bDiv).css("display","");this[u]&&n(i).jqGrid("expandRow",this)}))})},collapseRow:function(t){this.each(function(){var i=this,r,u;i.grid&&i.p.treeGrid&&(r=n(i).jqGrid("getNodeChildren",t),u=i.p.treeReader.expanded_field,n(r).each(function(){var t=n.jgrid.getAccessor(this,i.p.localReader.id);n("#"+t,i.grid.bDiv).css("display","none");this[u]&&n(i).jqGrid("collapseRow",this)}))})},getRootNodes:function(){var t=[];return this.each(function(){var i=this,u,r;if(i.grid&&i.p.treeGrid)switch(i.p.treeGridModel){case"nested":u=i.p.treeReader.level_field;n(i.p.data).each(function(){parseInt(this[u],10)===parseInt(i.p.tree_root_level,10)&&t.push(this)});break;case"adjacency":r=i.p.treeReader.parent_id_field;n(i.p.data).each(function(){(this[r]===null||String(this[r]).toLowerCase()=="null")&&t.push(this)})}}),t},getNodeDepth:function(t){var i=null;return this.each(function(){var r,u;if(this.grid&&this.p.treeGrid){r=this;switch(r.p.treeGridModel){case"nested":u=r.p.treeReader.level_field;i=parseInt(t[u],10)-parseInt(r.p.tree_root_level,10);break;case"adjacency":i=n(r).jqGrid("getNodeAncestors",t).length}}}),i},getNodeParent:function(t){var i=null;return this.each(function(){var r=this,o,s;if(r.grid&&r.p.treeGrid)switch(r.p.treeGridModel){case"nested":var u=r.p.treeReader.left_field,f=r.p.treeReader.right_field,e=r.p.treeReader.level_field,h=parseInt(t[u],10),c=parseInt(t[f],10),l=parseInt(t[e],10);n(this.p.data).each(function(){if(parseInt(this[e],10)===l-1&&parseInt(this[u],10)<h&&parseInt(this[f],10)>c)return i=this,!1});break;case"adjacency":o=r.p.treeReader.parent_id_field;s=r.p.localReader.id;n(this.p.data).each(function(){if(this[s]==t[o])return i=this,!1})}}),i},getNodeChildren:function(t){var i=[];return this.each(function(){var r=this,o,s;if(r.grid&&r.p.treeGrid)switch(r.p.treeGridModel){case"nested":var u=r.p.treeReader.left_field,f=r.p.treeReader.right_field,e=r.p.treeReader.level_field,h=parseInt(t[u],10),c=parseInt(t[f],10),l=parseInt(t[e],10);n(this.p.data).each(function(){parseInt(this[e],10)===l+1&&parseInt(this[u],10)>h&&parseInt(this[f],10)<c&&i.push(this)});break;case"adjacency":o=r.p.treeReader.parent_id_field;s=r.p.localReader.id;n(this.p.data).each(function(){this[o]==t[s]&&i.push(this)})}}),i},getFullTreeNode:function(t){var i=[];return this.each(function(){var r=this,f,o,s;if(r.grid&&r.p.treeGrid)switch(r.p.treeGridModel){case"nested":var u=r.p.treeReader.left_field,h=r.p.treeReader.right_field,e=r.p.treeReader.level_field,c=parseInt(t[u],10),l=parseInt(t[h],10),a=parseInt(t[e],10);n(this.p.data).each(function(){parseInt(this[e],10)>=a&&parseInt(this[u],10)>=c&&parseInt(this[u],10)<=l&&i.push(this)});break;case"adjacency":i.push(t);o=r.p.treeReader.parent_id_field;s=r.p.localReader.id;n(this.p.data).each(function(n){for(f=i.length,n=0;n<f;n++)if(i[n][s]==this[o]){i.push(this);break}})}}),i},getNodeAncestors:function(t){var i=[];return this.each(function(){if(this.grid&&this.p.treeGrid)for(var r=n(this).jqGrid("getNodeParent",t);r;)i.push(r),r=n(this).jqGrid("getNodeParent",r)}),i},isVisibleNode:function(t){var i=!0;return this.each(function(){var r=this,u,f;r.grid&&r.p.treeGrid&&(u=n(r).jqGrid("getNodeAncestors",t),f=r.p.treeReader.expanded_field,n(u).each(function(){return i=i&&this[f],i?void 0:!1}))}),i},isNodeLoaded:function(t){var i;return this.each(function(){var r=this,u;r.grid&&r.p.treeGrid&&(u=r.p.treeReader.leaf_field,i=t.loaded!==undefined?t.loaded:t[u]||n(r).jqGrid("getNodeChildren",t).length>0?!0:!1)}),i},expandNode:function(t){return this.each(function(){var i;if(this.grid&&this.p.treeGrid&&(i=this.p.treeReader.expanded_field,!t[i])){var r=n.jgrid.getAccessor(t,this.p.localReader.id),u=n("#"+r,this.grid.bDiv)[0],f=this.p._index[r];n(this).jqGrid("isNodeLoaded",this.p.data[f])?(t[i]=!0,n("div.treeclick",u).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus")):(t[i]=!0,n("div.treeclick",u).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus"),this.p.treeANode=u.rowIndex,this.p.datatype=this.p.treedatatype,this.p.treeGridModel=="nested"?n(this).jqGrid("setGridParam",{postData:{nodeid:r,n_left:t.lft,n_right:t.rgt,n_level:t.level}}):n(this).jqGrid("setGridParam",{postData:{nodeid:r,parentid:t.parent_id,n_level:t.level}}),n(this).trigger("reloadGrid"),this.p.treeGridModel=="nested"?n(this).jqGrid("setGridParam",{postData:{nodeid:"",n_left:"",n_right:"",n_level:""}}):n(this).jqGrid("setGridParam",{postData:{nodeid:"",parentid:"",n_level:""}}))}})},collapseNode:function(t){return this.each(function(){if(this.grid&&this.p.treeGrid&&t.expanded){t.expanded=!1;var i=n.jgrid.getAccessor(t,this.p.localReader.id),r=n("#"+i,this.grid.bDiv)[0];n("div.treeclick",r).removeClass(this.p.treeIcons.minus+" tree-minus").addClass(this.p.treeIcons.plus+" tree-plus")}})},SortTree:function(t,i,r,u){return this.each(function(){if(this.grid&&this.p.treeGrid){var e,l,c,o=[],f=this,s,h,a=n(this).jqGrid("getRootNodes");for(s=n.jgrid.from(a),s.orderBy(t,i,r,u),h=s.select(),e=0,l=h.length;e<l;e++)c=h[e],o.push(c),n(this).jqGrid("collectChildrenSortTree",o,c,t,i,r,u);n.each(o,function(t){var r=n.jgrid.getAccessor(this,f.p.localReader.id),i;t===0&&(i=n("#"+r,f.grid.bDiv),n("td",i).each(function(t){n(this).css("width",f.grid.headers[t].width+"px")}),f.grid.cols=i[0].cells);n("tbody",f.grid.bDiv).append(n("#"+r,f.grid.bDiv))});s=null;h=null;o=null}})},collectChildrenSortTree:function(t,i,r,u,f,e){return this.each(function(){if(this.grid&&this.p.treeGrid){var o,l,s,a,h,c;for(a=n(this).jqGrid("getNodeChildren",i),h=n.jgrid.from(a),h.orderBy(r,u,f,e),c=h.select(),o=0,l=c.length;o<l;o++)s=c[o],t.push(s),n(this).jqGrid("collectChildrenSortTree",t,s,r,u,f,e)}})},setTreeRow:function(t,i){var r=!1;return this.each(function(){var u=this;u.grid&&u.p.treeGrid&&(r=n(u).jqGrid("setRowData",t,i))}),r},delTreeNode:function(t){return this.each(function(){var i=this,r,u,f;if(i.grid&&i.p.treeGrid&&(r=n(i).jqGrid("getInd",t,!0),r)){if(u=n(i).jqGrid("getNodeChildren",r),u.length>0)for(f=0;f<u.length;f++)n(i).jqGrid("delRowData",u[f].id);n(i).jqGrid("delRowData",r.id)}})}})})(jQuery)