(function(n){n.jgrid.extend({setSubGrid:function(){return this.each(function(){var i=this,t,r;if(i.p.colNames.unshift(""),i.p.colModel.unshift({name:"subgrid",width:n.browser.safari?i.p.subGridWidth+i.p.cellLayout:i.p.subGridWidth,sortable:!1,resizable:!1,hidedlg:!0,search:!1,fixed:!0}),t=i.p.subGridModel,t[0])for(t[0].align=n.extend([],t[0].align||[]),r=0;r<t[0].name.length;r++)t[0].align[r]=t[0].align[r]||"left"})},addSubGridCell:function(n,t){var i="",u,r;return this.each(function(){i=this.formatCol(n,t);u=this.p.gridview;r=this.p.id}),u===!1?'<td role="grid" aria-describedby="'+r+'_subgrid" class="ui-sgcollapsed sgcollapsed" '+i+"><a href='javascript:void(0);'><span class='ui-icon ui-icon-plus'><\/span><\/a><\/td>":'<td role="grid" aria-describedby="'+r+'_subgrid" '+i+"><\/td>"},addSubGrid:function(t,i){return this.each(function(){var r=this,e,u,o,c,h,l,f;if(r.grid){n("td:eq("+i+")",t).click(function(){if(n(this).hasClass("sgcollapsed")){if(o=r.p.id,e=n(this).parent(),c=i>=1?"<td colspan='"+i+"'>&#160;<\/td>":"",u=n(e).attr("id"),f=!0,n.isFunction(r.p.subGridBeforeExpand)&&(f=r.p.subGridBeforeExpand(o+"_"+u,u)),f===!1)return!1;h=0;n.each(r.p.colModel,function(){(this.hidden===!0||this.name=="rn"||this.name=="cb")&&h++});l="<tr role='row' class='ui-subgrid'>"+c+"<td class='ui-widget-content subgrid-cell'><span class='ui-icon ui-icon-carat-1-sw'/><\/td><td colspan='"+parseInt(r.p.colNames.length-1-h,10)+"' class='ui-widget-content subgrid-data'><div id="+o+"_"+u+" class='tablediv'>";n(this).parent().after(l+"<\/div><\/td><\/tr>");n.isFunction(r.p.subGridRowExpanded)?r.p.subGridRowExpanded(o+"_"+u,u):y(e);n(this).html("<a href='javascript:void(0);'><span class='ui-icon ui-icon-minus'><\/span><\/a>").removeClass("sgcollapsed").addClass("sgexpanded")}else if(n(this).hasClass("sgexpanded")){if(f=!0,n.isFunction(r.p.subGridRowColapsed)&&(e=n(this).parent(),u=n(e).attr("id"),f=r.p.subGridRowColapsed(o+"_"+u,u)),f===!1)return!1;n(this).parent().next().remove(".ui-subgrid");n(this).html("<a href='javascript:void(0);'><span class='ui-icon ui-icon-plus'><\/span><\/a>").removeClass("sgexpanded").addClass("sgcollapsed")}return!1});var y=function(t){var f,i,u,e;if(f=n(t).attr("id"),i={nd_:(new Date).getTime()},i[r.p.prmNames.subgridid]=f,!r.p.subGridModel[0])return!1;if(r.p.subGridModel[0].params)for(e=0;e<r.p.subGridModel[0].params.length;e++)for(u=0;u<r.p.colModel.length;u++)r.p.colModel[u].name==r.p.subGridModel[0].params[e]&&(i[r.p.colModel[u].name]=n("td:eq("+u+")",t).text().replace(/\&#160\;/ig,""));if(!r.grid.hDiv.loading){r.grid.hDiv.loading=!0;n("#load_"+r.p.id).show();r.p.subgridtype||(r.p.subgridtype=r.p.datatype);n.isFunction(r.p.subgridtype)?r.p.subgridtype(i):r.p.subgridtype=r.p.subgridtype.toLowerCase();switch(r.p.subgridtype){case"xml":case"json":n.ajax(n.extend({type:r.p.mtype,url:r.p.subGridUrl,dataType:r.p.subgridtype,data:n.isFunction(r.p.serializeSubGridData)?r.p.serializeSubGridData(i):i,complete:function(t){r.p.subgridtype=="xml"?a(t.responseXML,f):v(n.jgrid.parse(t.responseText),f);t=null}},n.jgrid.ajaxOptions,r.p.ajaxSubgridOptions||{}))}}return!1},s=function(t,i,u){var f=n("<td align='"+r.p.subGridModel[0].align[u]+"'><\/td>").html(i);n(t).append(f)},a=function(t,i){for(var o,e,h=n("<table cellspacing='0' cellpadding='0' border='0'><tbody><\/tbody><\/table>"),f=n("<tr><\/tr>"),c,u=0;u<r.p.subGridModel[0].name.length;u++)o=n("<th class='ui-state-default ui-th-subgrid ui-th-column ui-th-"+r.p.direction+"'><\/th>"),n(o).html(r.p.subGridModel[0].name[u]),n(o).width(r.p.subGridModel[0].width[u]),n(f).append(o);return n(h).append(f),t&&(e=r.p.xmlReader.subgrid,n(e.root+" "+e.row,t).each(function(){if(f=n("<tr class='ui-widget-content ui-subtblcell'><\/tr>"),e.repeatitems===!0)n(e.cell,this).each(function(t){s(f,n(this).text()||"&#160;",t)});else{var t=r.p.subGridModel[0].mapping||r.p.subGridModel[0].name;if(t)for(u=0;u<t.length;u++)s(f,n(t[u],this).text()||"&#160;",u)}n(h).append(f)})),c=n("table:first",r.grid.bDiv).attr("id")+"_",n("#"+c+i).append(h),r.grid.hDiv.loading=!1,n("#load_"+r.p.id).hide(),!1},v=function(t,i){for(var c,l,e,h,u,v=n("<table cellspacing='0' cellpadding='0' border='0'><tbody><\/tbody><\/table>"),o=n("<tr><\/tr>"),a,y,f=0;f<r.p.subGridModel[0].name.length;f++)c=n("<th class='ui-state-default ui-th-subgrid ui-th-column ui-th-"+r.p.direction+"'><\/th>"),n(c).html(r.p.subGridModel[0].name[f]),n(c).width(r.p.subGridModel[0].width[f]),n(o).append(c);if(n(v).append(o),t&&(h=r.p.jsonReader.subgrid,l=t[h.root],typeof l!="undefined"))for(f=0;f<l.length;f++){if(e=l[f],o=n("<tr class='ui-widget-content ui-subtblcell'><\/tr>"),h.repeatitems===!0)for(h.cell&&(e=e[h.cell]),u=0;u<e.length;u++)s(o,e[u]||"&#160;",u);else if(a=r.p.subGridModel[0].mapping||r.p.subGridModel[0].name,a.length)for(u=0;u<a.length;u++)s(o,e[a[u]]||"&#160;",u);n(v).append(o)}return y=n("table:first",r.grid.bDiv).attr("id")+"_",n("#"+y+i).append(v),r.grid.hDiv.loading=!1,n("#load_"+r.p.id).hide(),!1};r.subGridXml=function(n,t){a(n,t)};r.subGridJson=function(n,t){v(n,t)}}})},expandSubGridRow:function(t){return this.each(function(){var u=this,i,r;(u.grid||t)&&u.p.subGrid===!0&&(i=n(this).jqGrid("getInd",t,!0),i&&(r=n("td.sgcollapsed",i)[0],r&&n(r).trigger("click")))})},collapseSubGridRow:function(t){return this.each(function(){var u=this,i,r;(u.grid||t)&&u.p.subGrid===!0&&(i=n(this).jqGrid("getInd",t,!0),i&&(r=n("td.sgexpanded",i)[0],r&&n(r).trigger("click")))})},toggleSubGridRow:function(t){return this.each(function(){var u=this,r,i;(u.grid||t)&&u.p.subGrid===!0&&(r=n(this).jqGrid("getInd",t,!0),r&&(i=n("td.sgcollapsed",r)[0],i?n(i).trigger("click"):(i=n("td.sgexpanded",r)[0],i&&n(i).trigger("click"))))})}})})(jQuery)