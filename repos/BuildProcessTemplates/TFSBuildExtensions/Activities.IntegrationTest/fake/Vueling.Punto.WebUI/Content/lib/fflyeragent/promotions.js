var xg=Ext.grid,rpp=params.ResultsPerPage,isDefault=!1,editWnd=null,itemEdit=null;Ext.onReady(function(){function t(n){return n==null?"":n}function a(n){return n==undefined?"":n.indexOf("XXX")!=-1?"":n}function d(n){return isDefault?(alert('No se pueden modificar las promociones "default"'),!1):n.idPromo>0?(alert("Las promociones no se pueden editar.\nLos detalles se guardant automáticamente al darlos de baja, no es necesario guardar la cabecera."),!1):n.idGroup==undefined?(alert("Debe seleccionar un grupo"),!1):n.code==undefined||n.code==""?(alert("Debe introducir un código para la promoción"),!1):n.purchaseStart==""&&n.purchaseEnd!=""||n.purchaseStart!=""&&n.purchaseEnd==""?(alert('Deben estar informadas las dos "Fechas de Compra" o ninguna'),!1):n.flightStart==""&&n.flightEnd!=""||n.flightStart!=""&&n.flightEnd==""?(alert('Deben estar informadas las dos "Fechas de Vuelo" o ninguna'),!1):n.purchaseStart!=""&&!Date.parseDate(n.purchaseStart,"d/m/Y")?(alert('"Fecha de Inicio de la Compra" incorrecta'),!1):n.purchaseEnd!=""&&!Date.parseDate(n.purchaseEnd,"d/m/Y")?(alert('"Fecha Final de la Compra" incorrecta'),!1):n.flightStart!=""&&!Date.parseDate(n.flightStart,"d/m/Y")?(alert('"Fecha de Inicio de Vuelo" incorrecta'),!1):n.flightEnd!=""&&!Date.parseDate(n.flightEnd,"d/m/Y")?(alert('"Fecha Final de Vuelo" incorrecta'),!1):Date.parseDate(n.purchaseStart,"d/m/Y")>Date.parseDate(n.purchaseEnd,"d/m/Y")?(alert('La "Fecha de Inicio de Compra" no puede ser mayor que la "Fecha Final de Compra"'),!1):Date.parseDate(n.flightStart,"d/m/Y")>Date.parseDate(n.flightEnd,"d/m/Y")?(alert('La "Fecha de Inicio de Vuelo" no puede ser mayor que la "Fecha Final de Vuelo"'),!1):n.origin==""&&n.destination!=""||n.origin!=""&&n.destination==""?(alert("Debe informar los dos aeropuertos"),!1):n.origin!=undefined&&n.destination!=undefined&&n.origin!=""&&n.destination!=""&&n.origin==n.destination?(alert("El aeropuerto de origen y de destino no pueden ser iguales"),!1):!0}function s(){return params.IdParent!=0?params.IdParent:params.IdPromo}function r(n){return n==""||n==undefined?0:n}function g(){u();editWnd=new EditWindow({title:"Edición del detalle de la promoción",border:!1,width:490,height:430,form:v()});editWnd.show();Ext.get("OperationP").on("click",function(){p()});Ext.get("OperationF").on("click",function(){w()});var n=o.getSelectionModel().getSelected();return Ext.getCmp("idRegistro").setValue(n.data.Id),Ext.getCmp("idPromo").setValue(s()),Ext.getCmp("idParentDetail").setValue(n.data.Parent),n.data.Operation=="Proporcional"?Ext.getCmp("OperationP").setValue(!0):Ext.getCmp("OperationF").setValue(!0),Ext.getCmp("Escala").setValue(n.data.Scale),Ext.getCmp("Base").setValue(n.data.Base),Ext.getCmp("Puntos").setValue(n.data.Points),Ext.getCmp("Ancilliary").setValue(n.data.AncilliaryCode),y(n.data.AncilliaryCode),!0}function v(){return new Ext.FormPanel({bodyStyle:"padding:15px 15px 0",defaultType:"textfield",waitMsg:"Cargando...",submitMethod:function(){var t={idRegistro:r(Ext.getCmp("idRegistro").value),idPromo:s(),idParent:r(Ext.getCmp("idParentDetail").value),operation:this.getForm().getValues().Operation,scale:r(Ext.getCmp("Escala").value),Base:r(Ext.getCmp("Base").value),points:r(Ext.getCmp("Puntos").value),ancilliary:document.getElementById("Ancilliary").value};ft(t)&&this.getForm().submit({method:"POST",waitTitle:"Conectando",waitMsg:"Enviando datos...",url:params.UrlSaveDetails,params:t,success:function(){u();n.reload()},failure:function(n,t){t.failureType=="server"?(obj=Ext.util.JSON.decode(t.response.responseText),alert(obj.errors.errorMsg)):(obj=Ext.util.JSON.decode(t.response.responseText),alert(obj.errorMsg));u()}})},items:[new Ext.form.Hidden({name:"idRegistro",id:"idRegistro"}),new Ext.form.Hidden({name:"idPromo",id:"idPromo"}),new Ext.form.Hidden({name:"idParentDetail",id:"idParentDetail"}),{xtype:"fieldset",defaultType:"radio",title:"Seleccione el tipo de operación",autoHeight:!0,items:[{id:"OperationP",name:"Operation",inputValue:"P",boxLabel:'<font color="#3F3F7E"> <b>Proporcional:<\/b><\/br>"Importe * Puntos / Escala" (únicamente se permite un registro para cada promoción)<\/font>',fieldLabel:"Operación",checked:!0},{id:"OperationF",name:"Operation",inputValue:"F",boxLabel:'<font color="#3F3F7E"><b>Fijo:<\/b><br> Devuelve los "Puntos", si el "Importe" se encuentra entre el valor de "Base" de este registro y el valor de "Base" del siguiente registro',labelSeparator:""}]},{xtype:"fieldset",title:"",autoHeight:!0,defaultType:"textfield",items:[{id:"Escala",name:"Escala",xtype:"numberfield",fieldLabel:"Escala",width:60,labelWidth:80,value:1,allowBlank:!1},{id:"Base",name:"Base",xtype:"numberfield",fieldLabel:"Base",width:60,labelWidth:80,value:0,allowBlank:!1},{id:"Puntos",name:"Puntos",fieldLabel:"Puntos",xtype:"numberfield",width:60,labelWidth:80,value:1,allowBlank:!1}]},{xtype:"fieldset",title:"",autoHeight:!0,defaultType:"textfield",items:[{id:"Ancilliary",name:"Ancilliary",labelWidth:150,fieldLabel:"Código Ancilliary",width:150,tooltip:"Pruebas"}]}]})}function tt(){}function it(){}function y(t){n.data.items.length>0&&n.data.items[0].json.Operation=="Proporcional"?(Ext.getCmp("Base").disable(),t==""||t==null?(Ext.getCmp("OperationF").disable(),Ext.getCmp("Ancilliary").disable()):Ext.getCmp("Ancilliary").enable()):(Ext.getCmp("Escala").disable(),Ext.getCmp("Ancilliary").disable(),Ext.getCmp("OperationP").disable())}function p(){(n.data.items.length==0||n.data.items[0].json.Operation=="Proporcional")&&(Ext.getCmp("Escala").enable(),Ext.getCmp("Base").disable(),Ext.getCmp("Ancilliary").enable())}function w(){(n.data.items.length==0||n.data.items[0].json.Operation=="Proporcional")&&(Ext.getCmp("Escala").setValue(1),Ext.getCmp("Escala").disable(),Ext.getCmp("Base").enable(),Ext.getCmp("Ancilliary").disable())}function rt(){u();editWnd=new EditWindow({title:"Alta del detalle de la promoción",border:!1,width:490,height:430,form:v()});editWnd.show();Ext.get("OperationP").on("click",function(){p()});Ext.get("OperationF").on("click",function(){w()});Ext.getCmp("cmbType").value=="R"?Ext.getCmp("OperationF").setValue(!0):Ext.getCmp("OperationP").setValue(!0);n.totalLength>0&&y("N")}function ut(){var t=o.getSelectionModel().getSelected(),i;if(t==null||t=="undefined"){alert("Debe seleccionar un registro");return}if(n.totalLength==1){alert("La promoción debe tener como mínimo un registro de detalle");return}confirm("Esta seguro que desea eliminar el registro ??")&&(i=t.data.Id,t.data.Parent!=null&&(i+=","+t.data.Parent),Ext.Ajax.request({url:params.UrlRemoveDetails,params:{detailList:i},success:function(){n.reload()},failure:function(n,t){t!=null&&t!=undefined?(respObj=Ext.decode(t.response.responseText),alert(respObj.errorMsg)):alert("Ocurrió un error desconocido intentando eliminar el grupo")}}))}function ft(n){if(n.ancilliary!=undefined&&n.ancilliary)for(i=0;i<n.ancilliary.length;i++)if("ABCDEFGHIJKLMNÑOPQRSTUVWXYZabcdefghijklmnñopqrstuvwxyz0123456789 ".indexOf(n.ancilliary.charAt(i),0)==-1)return alert("Ha introducido carácteres no permitidos."),!1;return n.points==""||n.points<0||n.points>1e5?(alert('El campo "Puntos" debe tener un valor entre 0 y 100.000'),!1):n.operation=="P"&&(n.scale==""||n.scale<1||n.scale>100)?(alert('El campo "Escala" debe tener un valor entre 1 y 100'),!1):n.Base=="F"&&(n.Base==""||n.Base<1||n.Base>1e5)?(alert('El campo "Base" debe tener un valor entre 1 y 100.000'),!1):!0}var u=function(){editWnd!=null&&editWnd.close();editWnd=null},h=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:params.UrlFetcherGroups}),reader:new Ext.data.JsonReader({root:"data",fields:["Id","Name"]}),remoteSort:!0}),f,e,nt,l;h.load();f=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:params.UrlFetcherAeropuertos}),reader:new Ext.data.JsonReader({root:"data",fields:["Id","Name"]}),remoteSort:!0});f.load();var b=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:params.UrlFetchPromotion}),reader:new Ext.data.JsonReader({root:"data",fields:["Id","Group","IdChild","Code","PurchaseStartString","PurchaseEndString","FlightStartString","FlightEndString","DH","Origin","Destination","Type"]}),listeners:{load:function(n){params.IdPromo!=0&&(Ext.getCmp("cmbGroup").setValue(""+n.data.items[0].data.Group.Id),Ext.getCmp("Code").setValue(n.data.items[0].data.Code),Ext.getCmp("PurchaseStart").setValue(t(n.data.items[0].data.PurchaseStartString)),Ext.getCmp("PurchaseEnd").setValue(t(n.data.items[0].data.PurchaseEndString)),Ext.getCmp("FlightStart").setValue(t(n.data.items[0].data.FlightStartString)),Ext.getCmp("FlightEnd").setValue(t(n.data.items[0].data.FlightEndString)),Ext.getCmp("cmbOrigin").setValue(t(n.data.items[0].data.Origin)),Ext.getCmp("cmbDestination").setValue(t(n.data.items[0].data.Destination)),Ext.getCmp("cmbType").setValue(n.data.items[0].data.Type),n.data.items[0].data.Code=="default"&&(isDefault=!0))}},remoteSort:!0}),n=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:params.UrlFetchPromotionDetails}),reader:new Ext.data.JsonReader({root:"data",fields:["Id","Parent","Scale","Base","Points","Operation","AncilliaryCode"]}),remoteSort:!0}),k=[{text:"Añadir",icon:params.UrlImageAdd,cls:"x-btn-text-icon",handler:rt},"-",{text:"Eliminar",icon:params.UrlImageDelete,cls:"x-btn-text-icon",handler:ut}],c=new Ext.grid.CheckboxSelectionModel,l=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer,c,{id:"id",header:"Id",hidden:!0,width:20,sortable:!0,dataIndex:"Id"},{header:"Escala",width:20,sortable:!0,dataIndex:"Scale"},{header:"Base",width:20,sortable:!0,dataIndex:"Base"},{header:"Puntos",width:20,sortable:!0,dataIndex:"Points"},{header:"Operación",width:40,sortable:!0,dataIndex:"Operation"},{header:"Código Ancilliary",sortable:!0,dataIndex:"AncilliaryCode"}]),o=new xg.GridPanel({el:"grid",region:"center",collapsible:!0,collapsed:!1,title:"Detalle",viewConfig:{forceFit:!0,scrollOffset:1},store:n,tbar:k,cm:l,sm:new Ext.grid.RowSelectionModel({singleSelect:!0}),header:!0,frame:!0,height:240,iconCls:"icon-grid"});e=new Ext.FormPanel({el:"promo",id:"editCurrentPromo",frame:!0,collapsible:!0,collapsed:!1,title:"Promoción",labelWidth:140,bodyStyle:"padding:5px 5px 0",height:255,keys:[{key:Ext.EventObject.ENTER,fn:function(n,t){t.stopEvent();e.doSubmit()}}],items:[{id:"cmbGroup",name:"cmbGroup",xtype:"combo",hiddenName:"Id",width:180,fieldLabel:"Grupo",store:h,displayField:"Name",valueField:"Id",selectOnFocus:!0,mode:"local",typeAhead:!0,editable:!1,triggerAction:"all"},{layout:"column",items:[{columnWidth:.5,layout:"form",items:[{id:"Code",name:"Code",xtype:"textfield",fieldLabel:"Código",allowBlank:!1,width:180,blankText:"Este campo es requerido"},{id:"PurchaseStart",name:"PurchaseStart",xtype:"datefield",fieldLabel:"Fecha Inicio de Compra",dataindex:"PurchaseStartString",format:"d/m/Y",width:180},{id:"FlightStart",name:"FlightStart",xtype:"datefield",fieldLabel:"Fecha Inicio de Vuelo",dataindex:"FlightStartString",format:"d/m/Y",width:180},{id:"cmbOrigin",name:"cmbOrigin",xtype:"combo",hiddenName:"Id",width:180,fieldLabel:"Origen",disableKeyFilter:!1,forceSelection:!0,store:f,displayField:"Id",valueField:"Id",typeAhead:!0,mode:"local",editable:!0,selectOnFocus:!0,triggerAction:"all",tpl:'<tpl for="."><div class="x-combo-list-item" >{Id} - {Name}<\/div><\/tpl>'}]},{columnWidth:.5,layout:"form",items:[{id:"cmbType",name:"cmbType",xtype:"combo",hiddenName:"id",fieldLabel:"Tipo",emptyText:"Selecciona un Tipo...",store:new Ext.data.SimpleStore({fields:["id","name"],data:[["O","Obtención"],["R","Redención"]]}),displayField:"name",editable:!1,valueField:"id",selectOnFocus:!0,width:180,mode:"local",typeAhead:!0,triggerAction:"all",value:"O"},{id:"PurchaseEnd",name:"FlightEnd",xtype:"datefield",fieldLabel:"Fecha Final de Compra",dataindex:"PurchaseEndString",format:"d/m/Y",width:180},{id:"FlightEnd",name:"FlightEnd",xtype:"datefield",fieldLabel:"Fecha Final de Vuelo",dataindex:"FlightEndString",format:"d/m/Y",width:180},{id:"cmbDestination",name:"cmbDestination",xtype:"combo",hiddenName:"Id",width:180,fieldLabel:"Destino",valueField:"Id",disableKeyFilter:!1,forceSelection:!0,store:f,displayField:"Id",selectOnFocus:!0,mode:"local",editable:!0,typeAhead:!0,triggerAction:"all",tpl:'<tpl for="."><div class="x-combo-list-item" >{Id} - {Name}<\/div><\/tpl>'}]}]}],buttons:[{id:"btnGuardar",name:"btnGuardar",text:"Guardar",handler:function(){e.doSubmit()}}],doSubmit:function(){var n={idPromo:params.IdPromo,idGroup:Ext.getCmp("cmbGroup").value,idParent:params.IdParent,code:document.getElementById("Code").value,purchaseStart:document.getElementById("PurchaseStart").value,purchaseEnd:document.getElementById("PurchaseEnd").value,flightStart:document.getElementById("FlightStart").value,flightEnd:document.getElementById("FlightEnd").value,origin:a(Ext.getCmp("cmbOrigin").value),destination:a(Ext.getCmp("cmbDestination").value),type:Ext.getCmp("cmbType").value};d(n)&&Ext.Ajax.request({url:params.UrlSave,params:n,success:function(n){respObj=Ext.decode(n.responseText);respObj.success?document.location.href=respObj.urlEditPromo:alert(respObj.errorMsg)},failure:function(n){n!=null&&n!=undefined?(respObj=Ext.decode(n.responseText),alert(respObj.errorMsg)):alert("Ocurrió un error desconocido intentando eliminar el grupo")}})}});itemEdit=g;nt=[{text:"Añadir",icon:params.UrlImageAdd,cls:"x-btn-text-icon",handler:tt},"-",{text:"Eliminar",icon:params.UrlImageDelete,cls:"x-btn-text-icon",handler:it}];l=new Ext.grid.ColumnModel([c,{header:"Códigos Ancilliary",sortable:!0,dataIndex:"Code"}]);e.render();o.render();b.load({params:{idPromo:params.IdPromo}});n.load({params:{idPromo:s()}})})