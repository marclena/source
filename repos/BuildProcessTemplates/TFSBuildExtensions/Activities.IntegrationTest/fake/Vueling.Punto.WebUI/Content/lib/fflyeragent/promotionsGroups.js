function editPromo(n){document.location.href=params.UrlEditPromo+n}Ext.onReady(function(){function v(){var i=new Ext.FormPanel({frame:!0,labelWidth:65,bodyStyle:"padding:15px 15px 0",defaultType:"textfield",waitMsg:"Cargando...",submitMethod:function(){this.getForm().submit({method:"POST",waitTitle:"Conectando",waitMsg:"Enviando datos...",url:params.UrlAddGroup,params:{name:document.getElementById("newGroup").value},success:function(n,i){respObj=Ext.decode(i.response.responseText);respObj.success?(f(),t.reload()):alert(respObj.message)},failure:function(n,t){t!=null&&t!=undefined?(respObj=Ext.decode(t.response.responseText),alert(respObj.message)):alert("Ocurrió un error desconocido intentando guardar el grupo")}})},items:[{id:"newGroup",fieldLabel:"Nombre",name:"newGroup",width:200,allowBlank:!1}]});n=new EditWindow({title:"Añadir grupo de promociones",width:350,height:130,form:i});n.show();n.render()}function y(){r.load();var i=new Ext.FormPanel({frame:!0,labelWidth:65,bodyStyle:"padding:15px 15px 0",defaultType:"textfield",waitMsg:"Cargando...",submitMethod:function(){this.getForm().submit({method:"POST",waitTitle:"Conectando",waitMsg:"Enviando datos...",url:params.UrlRemoveGroup,params:{idGroup:s(this.items.items[0].getSelectionModel().getSelected())},success:function(n,i){respObj=Ext.decode(i.response.responseText);respObj.success?(f(),r.reload(),t.reload()):alert(respObj.errorMsg)},failure:function(n,t){t!=null&&t!=undefined?(respObj=Ext.decode(t.response.responseText),alert(respObj.errorMsg)):alert("Ocurrió un error desconocido intentando eliminar el grupo")}})},items:[new Ext.grid.GridPanel({id:"gridGroups",region:"top",header:!1,border:!0,store:r,loadMask:!0,sm:new Ext.grid.RowSelectionModel({singleSelect:!0}),cm:new Ext.grid.ColumnModel([new Ext.grid.CheckboxSelectionModel,{header:"idGroup",hidden:!0,dataIndex:"idGroup",sortable:!1},{header:"Seleccione el nombre del grupo",dataIndex:"Name",sortable:!1,width:280}]),width:320,height:300,viewConfig:{forceFit:!1,scrollOffset:1},region:"center",frame:!0})]});n=new EditWindow({title:"Eliminar grupo de promociones",width:380,height:400,form:i});n.show();n.render()}function p(){editPromo(0)}function w(){var n=u.getSelectionModel().getSelected(),i;if(n==null||n=="undefined"){alert("Debe seleccionar una promoción");return}if(n.data.Code=="default"){alert('No se puede eliminar la promociones "default"');return}confirm('Esta seguro que desea eliminar la promoción "'+n.data.Code+'" del grupo "'+n.data["Group.Name"]+'" ??')&&(i=n.data.Id,n.data.IdParent!=0&&(i+=","+n.data.IdParent),Ext.Ajax.request({url:params.UrlRemovePromos,params:{promoList:i},success:function(){t.reload()},failure:function(n){n!=null&&n!=undefined?(respObj=Ext.decode(n.responseText),alert(respObj.errorMsg)):alert("Ocurrió un error desconocido intentando eliminar el grupo")}}))}function b(){Ext.Ajax.request({url:params.UrlPublishPromo,success:function(n){n!=null&&n!=undefined&&(respObj=Ext.decode(n.responseText),respObj.success?(alert("Promos published."),t.reload()):alert(respObj.errorMsg))},failure:function(n){n!=null&&n!=undefined?(respObj=Ext.decode(n.responseText),alert(respObj.errorMsg)):alert("Ocurrió un error desconocido al publicar las promociones")}})}var n=null,h=Ext.grid,i=params.ResultsPerPage,f=function(){n!=null&&n.close();n=null},t=new Ext.data.GroupingStore({proxy:new Ext.data.HttpProxy({url:params.UrlFetcherPromotions}),reader:new Ext.data.JsonReader({root:"data",totalProperty:"totalCount",Id:"Id"},[{name:"Group.Name"},{name:"IdParent"},{name:"Id"},{name:"Code"},{name:"desc"},{name:"PurchaseStartString"},{name:"PurchaseEndString"},{name:"FlightStartString"},{name:"FlightEndString"},{name:"Origin"},{name:"Destination"},{name:"Type"}]),baseParams:{query:"",limit:i},remoteSort:!0,sortInfo:{field:"Group.Name",direction:"ASC"},groupField:"Group.Name"}),r=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:params.UrlRemovableGroups,success:function(){}}),reader:new Ext.data.JsonReader({root:"data",fields:["Id","Name"]}),remoteSort:!1}),c=new Ext.PagingToolbar({pageSize:i,store:t,displayInfo:!0,items:["-"]}),l=[{text:"Añadir Grupo",icon:params.UrlImageAdd,cls:"x-btn-text-icon",handler:v},"-",{text:"Eliminar Grupo",icon:params.UrlImageDelete,cls:"x-btn-text-icon",handler:y},"   ","-","   ","Buscar:",new Ext.app.SearchField({store:t}),"   ","-","   ",{text:"Añadir Promoción",icon:params.UrlImageAdd,cls:"x-btn-text-icon",handler:p},"-",{text:"Eliminar Promoción",icon:params.UrlImageDelete,cls:"x-btn-text-icon",handler:w},"-",{text:"Publicar Promoción",icon:params.UrlImagePublish,cls:"x-btn-text-icon",handler:b}],a=new Ext.grid.CheckboxSelectionModel,e=new Ext.grid.ColumnModel([a,{id:"id",header:"Id",hidden:!0,width:20,sortable:!0,dataIndex:"IdPromo"},{header:"",width:10,renderer:function(n,t,i){return"<img src='"+params.UrlImageEdit+"' alt='Editar/Detalles' style='cursor:pointer;' onclick='editPromo(\""+i.data.Id+"\")' />"},sortable:!1},{header:"Grupo",hidden:!0,width:20,sortable:!0,dataIndex:"Group.Name",sortType:"asUCString"},{header:"Código",sortable:!0,dataIndex:"Code",sortType:"asUCString"},{header:"F.Ini. Compra",width:40,sortable:!0,dataIndex:"PurchaseStartString",sortType:"asDate"},{header:"F.Fin Compra",width:40,sortable:!0,dataIndex:"PurchaseEndString",sortType:"asDate"},{header:"F.Ini. Vuelo",width:40,sortable:!0,dataIndex:"FlightStartString",sortType:"asDate"},{header:"F.Fin Vuelo",width:40,sortable:!0,dataIndex:"FlightEndString",sortType:"asDate"},{header:"Origen",width:30,sortable:!0,dataIndex:"Origin",sortType:"asUCString"},{header:"Destino",width:30,sortable:!0,dataIndex:"Destination",sortType:"asUCString"},{header:"Tipo",width:40,sortable:!0,dataIndex:"Type",renderer:function(n,t,i){return i.data.Type=="O"?"Obtención":"Redención"}}]),o,u,s;e.defaultSortable=!0;o=new Ext.grid.GroupingView({forceFit:!0,groupTextTpl:'{text} ({[values.rs.length]} {[values.rs.length > 1 ? "Items" : "Item"]})'});u=new h.GridPanel({el:"grid",region:"center",viewConfig:{forceFit:!0,scrollOffset:1},store:t,tbar:l,bbar:c,cm:e,sm:new Ext.grid.RowSelectionModel({singleSelect:!0}),view:o,header:!1,frame:!0,height:450,iconCls:"icon-grid"});s=function(n){return n!=null&&n!=undefined?n.data.Id:0};u.render();t.load({params:{start:0,limit:i}})})