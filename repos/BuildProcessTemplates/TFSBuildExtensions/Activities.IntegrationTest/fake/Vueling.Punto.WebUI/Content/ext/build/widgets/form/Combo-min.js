Ext.form.ComboBox=Ext.extend(Ext.form.TriggerField,{defaultAutoCreate:{tag:"input",type:"text",size:"24",autocomplete:"off"},listClass:"",selectedClass:"x-combo-selected",triggerClass:"x-form-arrow-trigger",shadow:"sides",listAlign:"tl-bl?",maxHeight:300,triggerAction:"query",minChars:4,typeAhead:!1,queryDelay:500,pageSize:0,selectOnFocus:!1,queryParam:"query",loadingText:"Loading...",resizable:!1,handleHeight:8,editable:!0,allQuery:"",mode:"remote",minListWidth:70,forceSelection:!1,typeAheadDelay:250,lazyInit:!0,initComponent:function(){var n,r,u,i,e,t,f;if(Ext.form.ComboBox.superclass.initComponent.call(this),this.addEvents("expand","collapse","beforeselect","select","beforequery"),this.transform){if(this.allowDomMove=!1,n=Ext.getDom(this.transform),this.hiddenName||(this.hiddenName=n.name),!this.store){for(this.mode="local",r=[],u=n.options,i=0,e=u.length;i<e;i++)t=u[i],f=(Ext.isIE?t.getAttributeNode("value").specified:t.hasAttribute("value"))?t.value:t.text,t.selected&&(this.value=f),r.push([f,t.text]);this.store=new Ext.data.SimpleStore({id:0,fields:["value","text"],data:r});this.valueField="value";this.displayField="text"}n.name=Ext.id();this.lazyRender?Ext.removeNode(n):(this.target=!0,this.el=Ext.DomHelper.insertBefore(n,this.autoCreate||this.defaultAutoCreate),Ext.removeNode(n),this.render(this.el.parentNode))}this.selectedIndex=-1;this.mode=="local"&&(this.initialConfig.queryDelay===undefined&&(this.queryDelay=10),this.initialConfig.minChars===undefined&&(this.minChars=0))},onRender:function(n,t){if(Ext.form.ComboBox.superclass.onRender.call(this,n,t),this.hiddenName&&(this.hiddenField=this.el.insertSibling({tag:"input",type:"hidden",name:this.hiddenName,id:this.hiddenId||this.hiddenName},"before",!0),this.hiddenField.value=this.hiddenValue!==undefined?this.hiddenValue:this.value!==undefined?this.value:"",this.el.dom.removeAttribute("name")),Ext.isGecko&&this.el.dom.setAttribute("autocomplete","off"),this.lazyInit)this.on("focus",this.initList,this,{single:!0});else this.initList();this.editable||(this.editable=!0,this.setEditable(!1))},initList:function(){var n,t;if(!this.list){n="x-combo-list";this.list=new Ext.Layer({shadow:this.shadow,cls:[n,this.listClass].join(" "),constrain:!1});t=this.listWidth||Math.max(this.wrap.getWidth(),this.minListWidth);this.list.setWidth(t);this.list.swallowEvent("mousewheel");this.assetHeight=0;this.title&&(this.header=this.list.createChild({cls:n+"-hd",html:this.title}),this.assetHeight+=this.header.getHeight());this.innerList=this.list.createChild({cls:n+"-inner"});this.innerList.on("mouseover",this.onViewOver,this);this.innerList.on("mousemove",this.onViewMove,this);this.innerList.setWidth(t-this.list.getFrameWidth("lr"));this.pageSize&&(this.footer=this.list.createChild({cls:n+"-ft"}),this.pageTb=new Ext.PagingToolbar({store:this.store,pageSize:this.pageSize,renderTo:this.footer}),this.assetHeight+=this.footer.getHeight());this.tpl||(this.tpl='<tpl for="."><div class="'+n+'-item">{'+this.displayField+"}<\/div><\/tpl>");this.view=new Ext.DataView({applyTo:this.innerList,tpl:this.tpl,singleSelect:!0,selectedClass:this.selectedClass,itemSelector:this.itemSelector||"."+n+"-item"});this.view.on("click",this.onViewClick,this);if(this.bindStore(this.store,!0),this.resizable){this.resizer=new Ext.Resizable(this.list,{pinned:!0,handles:"se"});this.resizer.on("resize",function(n,t,i){this.maxHeight=i-this.handleHeight-this.list.getFrameWidth("tb")-this.assetHeight;this.listWidth=t;this.innerList.setWidth(t-this.list.getFrameWidth("lr"));this.restrictHeight()},this);this[this.pageSize?"footer":"innerList"].setStyle("margin-bottom",this.handleHeight+"px")}}},bindStore:function(n,t){if(this.store&&!t&&(this.store.un("beforeload",this.onBeforeLoad,this),this.store.un("load",this.onLoad,this),this.store.un("loadexception",this.collapse,this),n||(this.store=null,this.view&&this.view.setStore(null))),n){this.store=Ext.StoreMgr.lookup(n);this.store.on("beforeload",this.onBeforeLoad,this);this.store.on("load",this.onLoad,this);this.store.on("loadexception",this.collapse,this);this.view&&this.view.setStore(n)}},initEvents:function(){if(Ext.form.ComboBox.superclass.initEvents.call(this),this.keyNav=new Ext.KeyNav(this.el,{up:function(){this.inKeyMode=!0;this.selectPrev()},down:function(){this.isExpanded()?(this.inKeyMode=!0,this.selectNext()):this.onTriggerClick()},enter:function(){this.onViewClick();this.delayedCheck=!0;this.unsetDelayCheck.defer(10,this)},esc:function(){this.collapse()},tab:function(){this.onViewClick(!1);return!0},scope:this,doRelay:function(n,t,i){return i=="down"||this.scope.isExpanded()?Ext.KeyNav.prototype.doRelay.apply(this,arguments):!0},forceKeyDown:!0}),this.queryDelay=Math.max(this.queryDelay||10,this.mode=="local"?10:250),this.dqTask=new Ext.util.DelayedTask(this.initQuery,this),this.typeAhead&&(this.taTask=new Ext.util.DelayedTask(this.onTypeAhead,this)),this.editable!==!1)this.el.on("keyup",this.onKeyUp,this);if(this.forceSelection)this.on("blur",this.doForce,this)},onDestroy:function(){this.view&&(this.view.el.removeAllListeners(),this.view.el.remove(),this.view.purgeListeners());this.list&&this.list.destroy();this.bindStore(null);Ext.form.ComboBox.superclass.onDestroy.call(this)},unsetDelayCheck:function(){delete this.delayedCheck},fireKey:function(n){!n.isNavKeyPress()||this.isExpanded()||this.delayedCheck||this.fireEvent("specialkey",this,n)},onResize:function(n){if(Ext.form.ComboBox.superclass.onResize.apply(this,arguments),this.list&&this.listWidth===undefined){var t=Math.max(n,this.minListWidth);this.list.setWidth(t);this.innerList.setWidth(t-this.list.getFrameWidth("lr"))}},onEnable:function(){Ext.form.ComboBox.superclass.onEnable.apply(this,arguments);this.hiddenField&&(this.hiddenField.disabled=!1)},onDisable:function(){Ext.form.ComboBox.superclass.onDisable.apply(this,arguments);this.hiddenField&&(this.hiddenField.disabled=!0)},setEditable:function(n){if(n!=this.editable)if(this.editable=n,n)this.el.dom.setAttribute("readOnly",!1),this.el.un("mousedown",this.onTriggerClick,this),this.el.removeClass("x-combo-noedit");else{this.el.dom.setAttribute("readOnly",!0);this.el.on("mousedown",this.onTriggerClick,this);this.el.addClass("x-combo-noedit")}},onBeforeLoad:function(){this.hasFocus&&(this.innerList.update(this.loadingText?'<div class="loading-indicator">'+this.loadingText+"<\/div>":""),this.restrictHeight(),this.selectedIndex=-1)},onLoad:function(){this.hasFocus&&(this.store.getCount()>0?(this.expand(),this.restrictHeight(),this.lastQuery==this.allQuery?(this.editable&&this.el.dom.select(),this.selectByValue(this.value,!0)||this.select(0,!0)):(this.selectNext(),this.typeAhead&&this.lastKey!=Ext.EventObject.BACKSPACE&&this.lastKey!=Ext.EventObject.DELETE&&this.taTask.delay(this.typeAheadDelay))):this.onEmptyResults())},onTypeAhead:function(){if(this.store.getCount()>0){var i=this.store.getAt(0),n=i.data[this.displayField],r=n.length,t=this.getRawValue().length;t!=r&&(this.setRawValue(n),this.selectText(t,n.length))}},onSelect:function(n,t){this.fireEvent("beforeselect",this,n,t)!==!1&&(this.setValue(n.data[this.valueField||this.displayField]),this.collapse(),this.fireEvent("select",this,n,t))},getValue:function(){return this.valueField?typeof this.value!="undefined"?this.value:"":Ext.form.ComboBox.superclass.getValue.call(this)},clearValue:function(){this.hiddenField&&(this.hiddenField.value="");this.setRawValue("");this.lastSelectionText="";this.applyEmptyText();this.value=""},setValue:function(n){var t=n,i;this.valueField&&(i=this.findRecord(this.valueField,n),i?t=i.data[this.displayField]:this.valueNotFoundText!==undefined&&(t=this.valueNotFoundText));this.lastSelectionText=t;this.hiddenField&&(this.hiddenField.value=n);Ext.form.ComboBox.superclass.setValue.call(this,t);this.value=n},findRecord:function(n,t){var i;return this.store.getCount()>0&&this.store.each(function(r){if(r.data[n]==t)return i=r,!1}),i},onViewMove:function(){this.inKeyMode=!1},onViewOver:function(n,t){var i,r;this.inKeyMode||(i=this.view.findItemFromChild(t),i&&(r=this.view.indexOf(i),this.select(r,!1)))},onViewClick:function(n){var t=this.view.getSelectedIndexes()[0],i=this.store.getAt(t);if(i)this.onSelect(i,t);n!==!1&&this.el.focus()},restrictHeight:function(){this.innerList.dom.style.height="";var n=this.innerList.dom,t=this.list.getFrameWidth("tb"),i=Math.max(n.clientHeight,n.offsetHeight,n.scrollHeight);this.innerList.setHeight(i<this.maxHeight?"auto":this.maxHeight);this.list.beginUpdate();this.list.setHeight(this.innerList.getHeight()+t+(this.resizable?this.handleHeight:0)+this.assetHeight);this.list.alignTo(this.el,this.listAlign);this.list.endUpdate()},onEmptyResults:function(){this.collapse()},isExpanded:function(){return this.list&&this.list.isVisible()},selectByValue:function(n,t){if(n!==undefined&&n!==null){var i=this.findRecord(this.valueField||this.displayField,n);if(i)return this.select(this.store.indexOf(i),t),!0}return!1},select:function(n,t){if(this.selectedIndex=n,this.view.select(n),t!==!1){var i=this.view.getNode(n);i&&this.innerList.scrollChildIntoView(i,!1)}},selectNext:function(){var n=this.store.getCount();n>0&&(this.selectedIndex==-1?this.select(0):this.selectedIndex<n-1&&this.select(this.selectedIndex+1))},selectPrev:function(){var n=this.store.getCount();n>0&&(this.selectedIndex==-1?this.select(0):this.selectedIndex!=0&&this.select(this.selectedIndex-1))},onKeyUp:function(n){this.editable===!1||n.isSpecialKey()||(this.lastKey=n.getKey(),this.dqTask.delay(this.queryDelay))},validateBlur:function(){return!this.list||!this.list.isVisible()},initQuery:function(){this.doQuery(this.getRawValue())},doForce:function(){this.el.dom.value.length>0&&(this.el.dom.value=this.lastSelectionText===undefined?"":this.lastSelectionText,this.applyEmptyText())},doQuery:function(n,t){(n===undefined||n===null)&&(n="");var i={query:n,forceAll:t,combo:this,cancel:!1};if(this.fireEvent("beforequery",i)===!1||i.cancel)return!1;n=i.query;t=i.forceAll;(t===!0||n.length>=this.minChars)&&(this.lastQuery!==n?(this.lastQuery=n,this.mode=="local"?(this.selectedIndex=-1,t?this.store.clearFilter():this.store.filter(this.displayField,n),this.onLoad()):(this.store.baseParams[this.queryParam]=n,this.store.load({params:this.getParams(n)}),this.expand())):(this.selectedIndex=-1,this.onLoad()))},getParams:function(){var n={};return this.pageSize&&(n.start=0,n.limit=this.pageSize),n},collapse:function(){this.isExpanded()&&(this.list.hide(),Ext.getDoc().un("mousewheel",this.collapseIf,this),Ext.getDoc().un("mousedown",this.collapseIf,this),this.fireEvent("collapse",this))},collapseIf:function(n){n.within(this.wrap)||n.within(this.list)||this.collapse()},expand:function(){if(!this.isExpanded()&&this.hasFocus){this.list.alignTo(this.wrap,this.listAlign);this.list.show();this.innerList.setOverflow("auto");Ext.getDoc().on("mousewheel",this.collapseIf,this);Ext.getDoc().on("mousedown",this.collapseIf,this);this.fireEvent("expand",this)}},onTriggerClick:function(){if(!this.disabled)if(this.isExpanded())this.collapse(),this.el.focus();else{this.onFocus({});this.triggerAction=="all"?this.doQuery(this.allQuery,!0):this.doQuery(this.getRawValue());this.el.focus()}}});Ext.reg("combo",Ext.form.ComboBox)