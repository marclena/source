Ext.form.HtmlEditor=Ext.extend(Ext.form.Field,{enableFormat:!0,enableFontSize:!0,enableColors:!0,enableAlignments:!0,enableLists:!0,enableSourceEdit:!0,enableLinks:!0,enableFont:!0,createLinkText:"Please enter the URL for the link:",defaultLinkValue:"http://",fontFamilies:["Arial","Courier New","Tahoma","Times New Roman","Verdana"],defaultFont:"tahoma",validationEvent:!1,deferHeight:!0,initialized:!1,activated:!1,sourceEditMode:!1,onFocus:Ext.emptyFn,iframePad:3,hideMode:"offsets",defaultAutoCreate:{tag:"textarea",style:"width:500px;height:300px;",autocomplete:"off"},initComponent:function(){this.addEvents("initialize","activate","beforesync","beforepush","sync","push","editmodechange")},createFontOptions:function(){for(var r=[],u=this.fontFamilies,n,t,i=0,f=u.length;i<f;i++)n=u[i],t=n.toLowerCase(),r.push('<option value="',t,'" style="font-family:',n,';"',this.defaultFont==t?' selected="true">':">",n,"<\/option>");return r.join("")},createToolbar:function(n){function t(t,i,r){return{itemId:t,cls:"x-btn-icon x-edit-"+t,enableToggle:i!==!1,scope:n,handler:r||n.relayBtnCmd,clickEvent:"mousedown",tooltip:n.buttonTips[t]||undefined,tabIndex:-1}}var i=new Ext.Toolbar({renderTo:this.wrap.dom.firstChild});i.el.on("click",function(n){n.preventDefault()});if(this.enableFont&&!Ext.isSafari){this.fontSelect=i.el.createChild({tag:"select",cls:"x-font-select",html:this.createFontOptions()});this.fontSelect.on("change",function(){var n=this.fontSelect.dom.value;this.relayCmd("fontname",n);this.deferFocus()},this);i.add(this.fontSelect.dom,"-")}this.enableFormat&&i.add(t("bold"),t("italic"),t("underline"));this.enableFontSize&&i.add("-",t("increasefontsize",!1,this.adjustFont),t("decreasefontsize",!1,this.adjustFont));this.enableColors&&i.add("-",{itemId:"forecolor",cls:"x-btn-icon x-edit-forecolor",clickEvent:"mousedown",tooltip:n.buttonTips.forecolor||undefined,tabIndex:-1,menu:new Ext.menu.ColorMenu({allowReselect:!0,focus:Ext.emptyFn,value:"000000",plain:!0,selectHandler:function(n,t){this.execCmd("forecolor",Ext.isSafari||Ext.isIE?"#"+t:t);this.deferFocus()},scope:this,clickEvent:"mousedown"})},{itemId:"backcolor",cls:"x-btn-icon x-edit-backcolor",clickEvent:"mousedown",tooltip:n.buttonTips.backcolor||undefined,tabIndex:-1,menu:new Ext.menu.ColorMenu({focus:Ext.emptyFn,value:"FFFFFF",plain:!0,allowReselect:!0,selectHandler:function(n,t){Ext.isGecko?(this.execCmd("useCSS",!1),this.execCmd("hilitecolor",t),this.execCmd("useCSS",!0),this.deferFocus()):(this.execCmd(Ext.isOpera?"hilitecolor":"backcolor",Ext.isSafari||Ext.isIE?"#"+t:t),this.deferFocus())},scope:this,clickEvent:"mousedown"})});this.enableAlignments&&i.add("-",t("justifyleft"),t("justifycenter"),t("justifyright"));Ext.isSafari||(this.enableLinks&&i.add("-",t("createlink",!1,this.createLink)),this.enableLists&&i.add("-",t("insertorderedlist"),t("insertunorderedlist")),this.enableSourceEdit&&i.add("-",t("sourceedit",!0,function(n){this.toggleSourceEdit(n.pressed)})));this.tb=i},getDocMarkup:function(){return'<html><head><style type="text/css">body{border:0;margin:0;padding:3px;height:98%;cursor:text;}<\/style><\/head><body><\/body><\/html>'},getEditorBody:function(){return this.doc.body||this.doc.documentElement},onRender:function(n,t){var i,r;Ext.form.HtmlEditor.superclass.onRender.call(this,n,t);this.el.dom.style.border="0 none";this.el.dom.setAttribute("tabIndex",-1);this.el.addClass("x-hidden");Ext.isIE&&this.el.applyStyles("margin-top:-1px;margin-bottom:-1px;");this.wrap=this.el.wrap({cls:"x-html-editor-wrap",cn:{cls:"x-html-editor-tb"}});this.createToolbar(this);this.tb.items.each(function(n){n.itemId!="sourceedit"&&n.disable()});i=document.createElement("iframe");i.name=Ext.id();i.frameBorder="no";i.src=Ext.SSL_SECURE_URL||"javascript:false";this.wrap.dom.appendChild(i);this.iframe=i;Ext.isIE?(i.contentWindow.document.designMode="on",this.doc=i.contentWindow.document,this.win=i.contentWindow):(this.doc=i.contentDocument||window.frames[i.name].document,this.win=window.frames[i.name],this.doc.designMode="on");this.doc.open();this.doc.write(this.getDocMarkup());this.doc.close();r={run:function(){(this.doc.body||this.doc.readyState=="complete")&&(Ext.TaskMgr.stop(r),this.doc.designMode="on",this.initEditor.defer(10,this))},interval:10,duration:1e4,scope:this};Ext.TaskMgr.start(r);this.width||this.setSize(this.el.getSize())},onResize:function(n,t){var r,i;Ext.form.HtmlEditor.superclass.onResize.apply(this,arguments);this.el&&this.iframe&&(typeof n=="number"&&(r=n-this.wrap.getFrameWidth("lr"),this.el.setWidth(this.adjustWidth("textarea",r)),this.iframe.style.width=r+"px"),typeof t=="number"&&(i=t-this.wrap.getFrameWidth("tb")-this.tb.el.getHeight(),this.el.setHeight(this.adjustWidth("textarea",i)),this.iframe.style.height=i+"px",this.doc&&(this.getEditorBody().style.height=i-this.iframePad*2+"px")))},toggleSourceEdit:function(n){var t,i;if(n===undefined&&(n=!this.sourceEditMode),this.sourceEditMode=n===!0,t=this.tb.items.get("sourceedit"),t.pressed!==this.sourceEditMode){t.toggle(this.sourceEditMode);return}this.sourceEditMode?(this.tb.items.each(function(n){n.itemId!="sourceedit"&&n.disable()}),this.syncValue(),this.iframe.className="x-hidden",this.el.removeClass("x-hidden"),this.el.dom.removeAttribute("tabIndex"),this.el.focus()):(this.initialized&&this.tb.items.each(function(n){n.enable()}),this.pushValue(),this.iframe.className="",this.el.addClass("x-hidden"),this.el.dom.setAttribute("tabIndex",-1),this.deferFocus());i=this.lastSize;i&&(delete this.lastSize,this.setSize(i));this.fireEvent("editmodechange",this,this.sourceEditMode)},createLink:function(){var n=prompt(this.createLinkText,this.defaultLinkValue);n&&n!="http://"&&this.relayCmd("createlink",n)},adjustSize:Ext.BoxComponent.prototype.adjustSize,getResizeEl:function(){return this.wrap},getPositionEl:function(){return this.wrap},initEvents:function(){this.originalValue=this.getValue()},markInvalid:Ext.emptyFn,clearInvalid:Ext.emptyFn,setValue:function(n){Ext.form.HtmlEditor.superclass.setValue.call(this,n);this.pushValue()},cleanHtml:function(n){return n=String(n),n.length>5&&Ext.isSafari&&(n=n.replace(/\sclass="(?:Apple-style-span|khtml-block-placeholder)"/gi,"")),n=="&nbsp;"&&(n=""),n},syncValue:function(){var i,n,r,t;this.initialized&&(i=this.getEditorBody(),n=i.innerHTML,Ext.isSafari&&(r=i.getAttribute("style"),t=r.match(/text-align:(.*?);/i),t&&t[1]&&(n='<div style="'+t[0]+'">'+n+"<\/div>")),n=this.cleanHtml(n),this.fireEvent("beforesync",this,n)!==!1&&(this.el.dom.value=n,this.fireEvent("sync",this,n)))},pushValue:function(){if(this.initialized){var n=this.el.dom.value;!this.activated&&n.length<1&&(n="&nbsp;");this.fireEvent("beforepush",this,n)!==!1&&(this.getEditorBody().innerHTML=n,this.fireEvent("push",this,n))}},deferFocus:function(){this.focus.defer(10,this)},focus:function(){this.win&&!this.sourceEditMode?this.win.focus():this.el.focus()},initEditor:function(){var n=this.getEditorBody(),t=this.el.getStyles("font-size","font-family","background-image","background-repeat");t["background-attachment"]="fixed";n.bgProperties="fixed";Ext.DomHelper.applyStyles(n,t);Ext.EventManager.on(this.doc,{mousedown:this.onEditorEvent,dblclick:this.onEditorEvent,click:this.onEditorEvent,keyup:this.onEditorEvent,buffer:100,scope:this});if(Ext.isGecko)Ext.EventManager.on(this.doc,"keypress",this.applyCommand,this);if(Ext.isIE||Ext.isSafari||Ext.isOpera)Ext.EventManager.on(this.doc,"keydown",this.fixKeys,this);this.initialized=!0;this.fireEvent("initialize",this);this.pushValue()},onDestroy:function(){this.rendered&&(this.tb.items.each(function(n){n.menu&&(n.menu.removeAll(),n.menu.el&&n.menu.el.destroy());n.destroy()}),this.wrap.dom.innerHTML="",this.wrap.remove())},onFirstFocus:function(){var n,t;if(this.activated=!0,this.tb.items.each(function(n){n.enable()}),Ext.isGecko){this.win.focus();n=this.win.getSelection();n.focusNode&&n.focusNode.nodeType==3||(t=n.getRangeAt(0),t.selectNodeContents(this.getEditorBody()),t.collapse(!0),this.deferFocus());try{this.execCmd("useCSS",!0);this.execCmd("styleWithCSS",!1)}catch(i){}}this.fireEvent("activate",this)},adjustFont:function(n){var i=n.itemId=="increasefontsize"?1:-1,t;Ext.isSafari&&(i*=2);t=parseInt(this.doc.queryCommandValue("FontSize")||3,10);t=Math.max(1,t+i);this.execCmd("FontSize",t+(Ext.isSafari?"px":0))},onEditorEvent:function(){this.updateToolbar()},updateToolbar:function(){var n,t,i;if(!this.activated){this.onFirstFocus();return}n=this.tb.items.map;t=this.doc;this.enableFont&&!Ext.isSafari&&(i=(this.doc.queryCommandValue("FontName")||this.defaultFont).toLowerCase(),i!=this.fontSelect.dom.value&&(this.fontSelect.dom.value=i));this.enableFormat&&(n.bold.toggle(t.queryCommandState("bold")),n.italic.toggle(t.queryCommandState("italic")),n.underline.toggle(t.queryCommandState("underline")));this.enableAlignments&&(n.justifyleft.toggle(t.queryCommandState("justifyleft")),n.justifycenter.toggle(t.queryCommandState("justifycenter")),n.justifyright.toggle(t.queryCommandState("justifyright")));!Ext.isSafari&&this.enableLists&&(n.insertorderedlist.toggle(t.queryCommandState("insertorderedlist")),n.insertunorderedlist.toggle(t.queryCommandState("insertunorderedlist")));Ext.menu.MenuMgr.hideAll();this.syncValue()},relayBtnCmd:function(n){this.relayCmd(n.itemId)},relayCmd:function(n,t){this.win.focus();this.execCmd(n,t);this.updateToolbar();this.deferFocus()},execCmd:function(n,t){this.doc.execCommand(n,!1,t===undefined?null:t);this.syncValue()},applyCommand:function(n){if(n.ctrlKey){var i=n.getCharCode(),t;if(i>0){i=String.fromCharCode(i);switch(i){case"b":t="bold";break;case"i":t="italic";break;case"u":t="underline"}t&&(this.win.focus(),this.execCmd(t),this.deferFocus(),n.preventDefault())}}},insertAtCursor:function(n){if(this.activated)if(Ext.isIE){this.win.focus();var t=this.doc.selection.createRange();t&&(t.collapse(!0),t.pasteHTML(n),this.syncValue(),this.deferFocus())}else Ext.isGecko||Ext.isOpera?(this.win.focus(),this.execCmd("InsertHTML",n),this.deferFocus()):Ext.isSafari&&(this.execCmd("InsertText",n),this.deferFocus())},fixKeys:function(){return Ext.isIE?function(n){var r=n.getKey(),t,i;r==n.TAB?(n.stopEvent(),t=this.doc.selection.createRange(),t&&(t.collapse(!0),t.pasteHTML("&nbsp;&nbsp;&nbsp;&nbsp;"),this.deferFocus())):r==n.ENTER&&(t=this.doc.selection.createRange(),t&&(i=t.parentElement(),i&&i.tagName.toLowerCase()=="li"||(n.stopEvent(),t.pasteHTML("<br />"),t.collapse(!1),t.select())))}:Ext.isOpera?function(n){var t=n.getKey();t==n.TAB&&(n.stopEvent(),this.win.focus(),this.execCmd("InsertHTML","&nbsp;&nbsp;&nbsp;&nbsp;"),this.deferFocus())}:Ext.isSafari?function(n){var t=n.getKey();t==n.TAB&&(n.stopEvent(),this.execCmd("InsertText","\t"),this.deferFocus())}:void 0}(),getToolbar:function(){return this.tb},buttonTips:{bold:{title:"Bold (Ctrl+B)",text:"Make the selected text bold.",cls:"x-html-editor-tip"},italic:{title:"Italic (Ctrl+I)",text:"Make the selected text italic.",cls:"x-html-editor-tip"},underline:{title:"Underline (Ctrl+U)",text:"Underline the selected text.",cls:"x-html-editor-tip"},increasefontsize:{title:"Grow Text",text:"Increase the font size.",cls:"x-html-editor-tip"},decreasefontsize:{title:"Shrink Text",text:"Decrease the font size.",cls:"x-html-editor-tip"},backcolor:{title:"Text Highlight Color",text:"Change the background color of the selected text.",cls:"x-html-editor-tip"},forecolor:{title:"Font Color",text:"Change the color of the selected text.",cls:"x-html-editor-tip"},justifyleft:{title:"Align Text Left",text:"Align text to the left.",cls:"x-html-editor-tip"},justifycenter:{title:"Center Text",text:"Center text in the editor.",cls:"x-html-editor-tip"},justifyright:{title:"Align Text Right",text:"Align text to the right.",cls:"x-html-editor-tip"},insertunorderedlist:{title:"Bullet List",text:"Start a bulleted list.",cls:"x-html-editor-tip"},insertorderedlist:{title:"Numbered List",text:"Start a numbered list.",cls:"x-html-editor-tip"},createlink:{title:"Hyperlink",text:"Make the selected text a hyperlink.",cls:"x-html-editor-tip"},sourceedit:{title:"Source Edit",text:"Switch to source editing mode.",cls:"x-html-editor-tip"}}});Ext.reg("htmleditor",Ext.form.HtmlEditor)