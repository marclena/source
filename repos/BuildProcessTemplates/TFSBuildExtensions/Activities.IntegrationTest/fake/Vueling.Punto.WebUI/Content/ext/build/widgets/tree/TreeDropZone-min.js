Ext.dd.DropZone&&(Ext.tree.TreeDropZone=function(n,t){this.allowParentInsert=!1;this.allowContainerDrop=!1;this.appendOnly=!1;Ext.tree.TreeDropZone.superclass.constructor.call(this,n.innerCt,t);this.tree=n;this.dragOverData={};this.lastInsertClass="x-tree-no-status"},Ext.extend(Ext.tree.TreeDropZone,Ext.dd.DropZone,{ddGroup:"TreeDD",expandDelay:1e3,expandNode:function(n){n.hasChildNodes()&&!n.isExpanded()&&n.expand(!1,null,this.triggerCacheRefresh.createDelegate(this))},queueExpand:function(n){this.expandProcId=this.expandNode.defer(this.expandDelay,this,[n])},cancelExpand:function(){this.expandProcId&&(clearTimeout(this.expandProcId),this.expandProcId=!1)},isValidDropPoint:function(n,t,i,r,u){var e,o,f,s;return!n||!u?!1:(e=n.node,o=u.node,!(e&&e.isTarget&&t))?!1:t=="append"&&e.allowChildren===!1?!1:(t=="above"||t=="below")&&e.parentNode&&e.parentNode.allowChildren===!1?!1:o&&(e==o||o.contains(e))?!1:(f=this.dragOverData,f.tree=this.tree,f.target=e,f.data=u,f.point=t,f.source=i,f.rawEvent=r,f.dropNode=o,f.cancel=!1,s=this.tree.fireEvent("nodedragover",f),f.cancel===!1&&s!==!1)},getDropPoint:function(n,t){var i=t.node,o,s;if(i.isRoot)return i.allowChildren!==!1?"append":!1;var h=t.ddel,r=Ext.lib.Dom.getY(h),f=r+h.offsetHeight,u=Ext.lib.Event.getPageY(n),e=i.allowChildren===!1||i.isLeaf();return this.appendOnly||i.parentNode.allowChildren===!1?e?!1:"append":(o=!1,this.allowParentInsert||(o=i.hasChildNodes()&&i.isExpanded()),s=(f-r)/(e?2:3),u>=r&&u<r+s?"above":!o&&(e||u>=f-s&&u<=f)?"below":"append")},onNodeEnter:function(){this.cancelExpand()},onNodeOver:function(n,t,i,r){var u=this.getDropPoint(i,n,t),o=n.node,e,s,f;return this.expandProcId||u!="append"||!o.hasChildNodes()||n.node.isExpanded()?u!="append"&&this.cancelExpand():this.queueExpand(o),e=this.dropNotAllowed,this.isValidDropPoint(n,u,t,i,r)&&u&&(s=n.ddel,u=="above"?(e=n.node.isFirst()?"x-tree-drop-ok-above":"x-tree-drop-ok-between",f="x-tree-drag-insert-above"):u=="below"?(e=n.node.isLast()?"x-tree-drop-ok-below":"x-tree-drop-ok-between",f="x-tree-drag-insert-below"):(e="x-tree-drop-ok-append",f="x-tree-drag-append"),this.lastInsertClass!=f&&(Ext.fly(s).replaceClass(this.lastInsertClass,f),this.lastInsertClass=f)),e},onNodeOut:function(n){this.cancelExpand();this.removeDropIndicators(n)},onNodeDrop:function(n,t,i,r){var e=this.getDropPoint(i,n,t),u=n.node;if(u.ui.startDrop(),!this.isValidDropPoint(n,e,t,i,r))return u.ui.endDrop(),!1;var o=r.node||(t.getTreeNode?t.getTreeNode(r,u,e,i):null),f={tree:this.tree,target:u,data:r,point:e,source:t,rawEvent:i,dropNode:o,cancel:!o},s=this.tree.fireEvent("beforenodedrop",f);return s===!1||f.cancel===!0||!f.dropNode?(u.ui.endDrop(),!1):(u=f.target,e!="append"||u.isExpanded()?this.completeDrop(f):u.expand(!1,null,function(){this.completeDrop(f)}.createDelegate(this)),!0)},completeDrop:function(n){var r=n.dropNode,f=n.point,t=n.target,i,u,e;for(r instanceof Array||(r=[r]),u=0,e=r.length;u<e;u++)i=r[u],f=="above"?t.parentNode.insertBefore(i,t):f=="below"?t.parentNode.insertBefore(i,t.nextSibling):t.appendChild(i);i.ui.focus();this.tree.hlDrop&&i.ui.highlight();t.ui.endDrop();this.tree.fireEvent("nodedrop",n)},afterNodeMoved:function(n,t,i,r,u){this.tree.hlDrop&&(u.ui.focus(),u.ui.highlight());this.tree.fireEvent("nodedrop",this.tree,r,t,n,i)},getTree:function(){return this.tree},removeDropIndicators:function(n){if(n&&n.ddel){var t=n.ddel;Ext.fly(t).removeClass(["x-tree-drag-insert-above","x-tree-drag-insert-below","x-tree-drag-append"]);this.lastInsertClass="_noclass"}},beforeDragDrop:function(){return this.cancelExpand(),!0},afterRepair:function(n){n&&Ext.enableFx&&n.node.ui.highlight();this.hideProxy()}}))