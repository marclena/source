Ext.grid.RowSelectionModel=function(n){Ext.apply(this,n);this.selections=new Ext.util.MixedCollection(!1,function(n){return n.id});this.last=!1;this.lastActive=!1;this.addEvents("selectionchange","beforerowselect","rowselect","rowdeselect");Ext.grid.RowSelectionModel.superclass.constructor.call(this)};Ext.extend(Ext.grid.RowSelectionModel,Ext.grid.AbstractSelectionModel,{singleSelect:!1,initEvents:function(){if(this.grid.enableDragDrop||this.grid.enableDrag)this.grid.on("rowclick",function(n,t,i){i.button!==0||i.shiftKey||i.ctrlKey||(this.selectRow(t,!1),n.view.focusRow(t))},this);else this.grid.on("rowmousedown",this.handleMouseDown,this);this.rowNav=new Ext.KeyNav(this.grid.getGridEl(),{up:function(n){if(n.shiftKey)if(this.last!==!1&&this.lastActive!==!1){var t=this.last;this.selectRange(this.last,this.lastActive-1);this.grid.getView().focusRow(this.lastActive);t!==!1&&(this.last=t)}else this.selectFirstRow();else this.selectPrevious(n.shiftKey)},down:function(n){if(n.shiftKey)if(this.last!==!1&&this.lastActive!==!1){var t=this.last;this.selectRange(this.last,this.lastActive+1);this.grid.getView().focusRow(this.lastActive);t!==!1&&(this.last=t)}else this.selectFirstRow();else this.selectNext(n.shiftKey)},scope:this});var n=this.grid.view;n.on("refresh",this.onRefresh,this);n.on("rowupdated",this.onRowUpdated,this);n.on("rowremoved",this.onRemove,this)},onRefresh:function(){var f=this.grid.store,i,t=this.getSelections(),n,r,u;for(this.clearSelections(!0),n=0,r=t.length;n<r;n++)u=t[n],(i=f.indexOfId(u.id))!=-1&&this.selectRow(i,!0);t.length!=this.selections.getCount()&&this.fireEvent("selectionchange",this)},onRemove:function(n,t,i){this.selections.remove(i)!==!1&&this.fireEvent("selectionchange",this)},onRowUpdated:function(n,t,i){if(this.isSelected(i))n.onRowSelect(t)},selectRecords:function(n,t){var r,i,u;for(t||this.clearSelections(),r=this.grid.store,i=0,u=n.length;i<u;i++)this.selectRow(r.indexOf(n[i]),!0)},getCount:function(){return this.selections.length},selectFirstRow:function(){this.selectRow(0)},selectLastRow:function(n){this.selectRow(this.grid.store.getCount()-1,n)},selectNext:function(n){return this.hasNext()?(this.selectRow(this.last+1,n),this.grid.getView().focusRow(this.last),!0):!1},selectPrevious:function(n){return this.hasPrevious()?(this.selectRow(this.last-1,n),this.grid.getView().focusRow(this.last),!0):!1},hasNext:function(){return this.last!==!1&&this.last+1<this.grid.store.getCount()},hasPrevious:function(){return!!this.last},getSelections:function(){return[].concat(this.selections.items)},getSelected:function(){return this.selections.itemAt(0)},each:function(n,t){for(var r=this.getSelections(),i=0,u=r.length;i<u;i++)if(n.call(t||this,r[i],i)===!1)return!1;return!0},clearSelections:function(n){if(!this.locked){if(n!==!0){var i=this.grid.store,t=this.selections;t.each(function(n){this.deselectRow(i.indexOfId(n.id))},this);t.clear()}else this.selections.clear();this.last=!1}},selectAll:function(){if(!this.locked){this.selections.clear();for(var n=0,t=this.grid.store.getCount();n<t;n++)this.selectRow(n,!0)}},hasSelection:function(){return this.selections.length>0},isSelected:function(n){var t=typeof n=="number"?this.grid.store.getAt(n):n;return t&&this.selections.key(t.id)?!0:!1},isIdSelected:function(n){return this.selections.key(n)?!0:!1},handleMouseDown:function(n,t,i){var r,u,f;i.button!==0||this.isLocked()||(r=this.grid.getView(),i.shiftKey&&this.last!==!1?(u=this.last,this.selectRange(u,t,i.ctrlKey),this.last=u,r.focusRow(t)):(f=this.isSelected(t),i.ctrlKey&&f?this.deselectRow(t):(!f||this.getCount()>1)&&(this.selectRow(t,i.ctrlKey||i.shiftKey),r.focusRow(t))))},selectRows:function(n,t){t||this.clearSelections();for(var i=0,r=n.length;i<r;i++)this.selectRow(n[i],!0)},selectRange:function(n,t,i){var r;if(!this.locked)if(i||this.clearSelections(),n<=t)for(r=n;r<=t;r++)this.selectRow(r,!0);else for(r=n;r>=t;r--)this.selectRow(r,!0)},deselectRange:function(n,t,i){if(!this.locked)for(var r=n;r<=t;r++)this.deselectRow(r,i)},selectRow:function(n,t,i){if(!this.locked&&!(n<0)&&!(n>=this.grid.store.getCount())){var r=this.grid.store.getAt(n);if(r&&this.fireEvent("beforerowselect",this,n,t,r)!==!1){if((!t||this.singleSelect)&&this.clearSelections(),this.selections.add(r),this.last=this.lastActive=n,!i)this.grid.getView().onRowSelect(n);this.fireEvent("rowselect",this,n,r);this.fireEvent("selectionchange",this)}}},deselectRow:function(n,t){if(!this.locked){this.last==n&&(this.last=!1);this.lastActive==n&&(this.lastActive=!1);var i=this.grid.store.getAt(n);if(i){if(this.selections.remove(i),!t)this.grid.getView().onRowDeselect(n);this.fireEvent("rowdeselect",this,n,i);this.fireEvent("selectionchange",this)}}},restoreLast:function(){this._last&&(this.last=this._last)},acceptsNav:function(n,t,i){return!i.isHidden(t)&&i.isCellEditable(t,n)},onEditorKey:function(n,t){var f=t.getKey(),u,r=this.grid,i=r.activeEditor,e=t.shiftKey;f==t.TAB?(t.stopEvent(),i.completeEdit(),u=e?r.walkCells(i.row,i.col-1,-1,this.acceptsNav,this):r.walkCells(i.row,i.col+1,1,this.acceptsNav,this)):f==t.ENTER?(t.stopEvent(),i.completeEdit(),u=e?r.walkCells(i.row-1,i.col,-1,this.acceptsNav,this):r.walkCells(i.row+1,i.col,1,this.acceptsNav,this)):f==t.ESC&&i.cancelEdit();u&&r.startEditing(u[0],u[1])}})