Ext.grid.GroupingView=Ext.extend(Ext.grid.GridView,{hideGroupedColumn:!1,showGroupName:!0,startCollapsed:!1,enableGrouping:!0,enableGroupingMenu:!0,enableNoGroups:!0,emptyGroupText:"(None)",ignoreAdd:!1,groupTextTpl:"{text}",gidSeed:1e3,initTemplates:function(){Ext.grid.GroupingView.superclass.initTemplates.call(this);this.state={};var n=this.grid.getSelectionModel();n.on(n.selectRow?"beforerowselect":"beforecellselect",this.onBeforeRowSelect,this);this.startGroup||(this.startGroup=new Ext.XTemplate('<div id="{groupId}" class="x-grid-group {cls}">','<div id="{groupId}-hd" class="x-grid-group-hd" style="{style}"><div>',this.groupTextTpl,"<\/div><\/div>",'<div id="{groupId}-bd" class="x-grid-group-body">'));this.startGroup.compile();this.endGroup="<\/div><\/div>"},findGroup:function(n){return Ext.fly(n).up(".x-grid-group",this.mainBody.dom)},getGroups:function(){return this.hasRows()?this.mainBody.dom.childNodes:[]},onAdd:function(){if(this.enableGrouping&&!this.ignoreAdd){var n=this.getScrollState();this.refresh();this.restoreScroll(n)}else this.enableGrouping||Ext.grid.GroupingView.superclass.onAdd.apply(this,arguments)},onRemove:function(n,t){Ext.grid.GroupingView.superclass.onRemove.apply(this,arguments);var i=document.getElementById(t._groupId);i&&i.childNodes[1].childNodes.length<1&&Ext.removeNode(i);this.applyEmptyText()},refreshRow:function(){this.ds.getCount()==1?this.refresh():(this.isUpdating=!0,Ext.grid.GroupingView.superclass.refreshRow.apply(this,arguments),this.isUpdating=!1)},beforeMenuShow:function(){var t=this.getGroupField(),i=this.hmenu.items.get("groupBy"),n;i&&i.setDisabled(this.cm.config[this.hdCtxIndex].groupable===!1);n=this.hmenu.items.get("showGroups");n&&(!t||n.setDisabled(this.cm.config[this.hdCtxIndex].groupable===!1),n.setChecked(!!t))},renderUI:function(){Ext.grid.GroupingView.superclass.renderUI.call(this);this.mainBody.on("mousedown",this.interceptMouse,this);if(this.enableGroupingMenu&&this.hmenu){this.hmenu.add("-",{id:"groupBy",text:this.groupByText,handler:this.onGroupByClick,scope:this,iconCls:"x-group-by-icon"});this.enableNoGroups&&this.hmenu.add({id:"showGroups",text:this.showGroupsText,checked:!0,checkHandler:this.onShowGroupsClick,scope:this});this.hmenu.on("beforeshow",this.beforeMenuShow,this)}},onGroupByClick:function(){this.grid.store.groupBy(this.cm.getDataIndex(this.hdCtxIndex));this.beforeMenuShow()},onShowGroupsClick:function(n,t){t?this.onGroupByClick():this.grid.store.clearGrouping()},toggleGroup:function(n,t){this.grid.stopEditing();n=Ext.getDom(n);var i=Ext.fly(n);t=t!==undefined?t:i.hasClass("x-grid-group-collapsed");this.state[i.dom.id]=t;i[t?"removeClass":"addClass"]("x-grid-group-collapsed")},toggleAllGroups:function(n){for(var i=this.getGroups(),t=0,r=i.length;t<r;t++)this.toggleGroup(i[t],n)},expandAllGroups:function(){this.toggleAllGroups(!0)},collapseAllGroups:function(){this.toggleAllGroups(!1)},interceptMouse:function(n){var t=n.getTarget(".x-grid-group-hd",this.mainBody);t&&(n.stopEvent(),this.toggleGroup(t.parentNode))},getGroup:function(n,t,i,r,u,f){var e=i?i(n,{},t,r,u,f):String(n);return e===""&&(e=this.cm.config[u].emptyGroupText||this.emptyGroupText),e},getGroupField:function(){return this.grid.store.getGroupState()},renderRows:function(){var n=this.getGroupField(),t=!!n,i,r;return this.hideGroupedColumn&&(i=this.cm.findColumnIndex(n),t||this.lastGroupField===undefined?t&&this.lastGroupField===undefined?(this.lastGroupField=n,this.cm.setHidden(i,!0)):t&&this.lastGroupField!==undefined&&n!==this.lastGroupField&&(this.mainBody.update(""),r=this.cm.findColumnIndex(this.lastGroupField),this.cm.setHidden(r,!1),this.lastGroupField=n,this.cm.setHidden(i,!0)):(this.mainBody.update(""),this.cm.setHidden(this.cm.findColumnIndex(this.lastGroupField),!1),delete this.lastGroupField)),Ext.grid.GroupingView.superclass.renderRows.apply(this,arguments)},doRender:function(n,t,i,r,u,f){var h,p,d,g,s,o;if(t.length<1)return"";if(h=this.getGroupField(),p=this.cm.findColumnIndex(h),this.enableGrouping=!!h,!this.enableGrouping||this.isUpdating)return Ext.grid.GroupingView.superclass.doRender.apply(this,arguments);for(var nt="width:"+this.getTotalWidth()+";",tt=this.grid.getGridEl().id,v=this.cm.config[p],it=v.groupRenderer||v.renderer,rt=this.showGroupName?(v.groupName||v.header)+": ":"",w=[],c,l,e=0,y=t.length;e<y;e++){var b=r+e,a=t[e],k=a.data[h],o=this.getGroup(k,a,it,b,p,i);c&&c.group==o?c.rs.push(a):(l=tt+"-gp-"+h+"-"+Ext.util.Format.htmlEncode(o),d=typeof this.state[l]!="undefined"?!this.state[l]:this.startCollapsed,g=d?"x-grid-group-collapsed":"",c={group:o,gvalue:k,text:rt+o,groupId:l,startRow:b,rs:[a],cls:g,style:nt},w.push(c));a._groupId=l}for(s=[],e=0,y=w.length;e<y;e++)o=w[e],this.doGroupStart(s,o,n,i,u),s[s.length]=Ext.grid.GroupingView.superclass.doRender.call(this,n,o.rs,i,o.startRow,u,f),this.doGroupEnd(s,o,n,i,u);return s.join("")},getGroupId:function(n){var u=this.grid.getGridEl().id,t=this.getGroupField(),i=this.cm.findColumnIndex(t),r=this.cm.config[i],f=r.groupRenderer||r.renderer,e=this.getGroup(n,{data:{}},f,0,i,this.ds);return u+"-gp-"+t+"-"+Ext.util.Format.htmlEncode(n)},doGroupStart:function(n,t){n[n.length]=this.startGroup.apply(t)},doGroupEnd:function(n){n[n.length]=this.endGroup},getRows:function(){var n,r,u,t,f,i,e;if(!this.enableGrouping)return Ext.grid.GroupingView.superclass.getRows.call(this);for(n=[],u=this.getGroups(),t=0,f=u.length;t<f;t++)for(r=u[t].childNodes[1].childNodes,i=0,e=r.length;i<e;i++)n[n.length]=r[i];return n},updateGroupWidths:function(){var i,t,n,r;if(this.enableGrouping&&this.hasRows())for(i=Math.max(this.cm.getTotalWidth(),this.el.dom.offsetWidth-this.scrollOffset)+"px",t=this.getGroups(),n=0,r=t.length;n<r;n++)t[n].firstChild.style.width=i},onColumnWidthUpdated:function(){this.updateGroupWidths()},onAllColumnWidthsUpdated:function(){this.updateGroupWidths()},onColumnHiddenUpdated:function(){this.updateGroupWidths()},onLayout:function(){this.updateGroupWidths()},onBeforeRowSelect:function(n,t){var i,r;this.enableGrouping&&(i=this.getRow(t),i&&!i.offsetParent&&(r=this.findGroup(i),this.toggleGroup(r,!0)))},groupByText:"Group By This Field",showGroupsText:"Show in Groups"});Ext.grid.GroupingView.GROUP_ID=1e3