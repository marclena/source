/**
 * Ext.ux.MetaForm
 *
 * @author    Ing. Jozef Sakalos
 * @copyright (c) 2008, by Ing. Jozef Sakalos
 * @date      6. February 2007
 * @version   $Id: Ext.ux.MetaForm.js 80 2008-03-20 00:44:36Z jozo $
 *
 * @license Ext.ux.MetaForm is licensed under the terms of
 * the Open Source LGPL 3.0 license.  Commercial use is permitted to the extent
 * that the code/component(s) do NOT become part of another Open Source or Commercially
 * licensed development library or toolkit without explicit permission.
 * 
 * License details: http://www.gnu.org/licenses/lgpl.html
 */
Ext.isArray||(Ext.isArray=function(n){return n&&"function"==typeof n.pop});Ext.ux.MetaForm=Ext.extend(Ext.FormPanel,{autoInit:!0,border:!1,frame:!0,loadingText:"Cargando...",savingText:"Guardando...",buttonMinWidth:90,columnCount:1,initComponent:function(){Ext.apply(this,{items:this.items||{}});"function"==typeof this.getButton&&(this.buttons=this.getButtons());Ext.ux.MetaForm.superclass.initComponent.apply(this,arguments);this.addEvents("cancel","ok");this.form.on({beforeaction:{scope:this,fn:this.beforeAction},actioncomplete:{scope:this,fn:function(n,t){if("load"===t.type&&t.result.metaData)this.onMetaChange(this,t.result.metaData);else"submit"==t.type&&this.updateBoundData()}}});this.form.trackResetOnLoad=!0},beforeAction:function(n,t){t.success=function(n){var t=this.processResponse(n);if(t===!0||!t.success||!t.data){this.failureType=Ext.form.Action.LOAD_FAILURE;this.form.afterAction(this,!1);return}this.form.afterAction(this,!0);this.form.clearInvalid();this.form.setValues(t.data)}},bind:function(n){this.data=n;this.form.setValues(this.data)},getButtons:function(){var n=[];return Ext.isArray(this.createButtons)&&Ext.each(this.createButtons,function(t){var i;switch(t){case"meta":i=this.getButton(t,{handler:this.load.createDelegate(this,[{params:{meta:!0}}])});break;case"load":i=this.getButton(t,{scope:this,handler:this.load});break;case"defaults":i=this.getButton(t,{scope:this,handler:this.setDefaultValues});break;case"reset":i=this.getButton(t,{scope:this,handler:this.reset});break;case"save":case"submit":i=this.getButton(t,{handler:this.submit.createDelegate(this,[{params:{cmd:"setPref"}}])});break;case"ok":i=this.getButton(t,{scope:this,handler:this.onOk});break;case"cancel":i=this.getButton(t,{scope:this,handler:this.onCancel})}i&&(Ext.apply(i,{minWidth:this.buttonMinWidth}),n.push(i))},this),n},getOptions:function(n){var t={url:this.url,method:this.method||"post"};return Ext.apply(t,n),t.params=Ext.apply(this.baseParams||{},n.params),t},getValues:function(){var n={};return this.form.items.each(function(t){n[t.name]=t.getValue()}),n},load:function(n){var t=this.getOptions(n);this.loadingText&&(t.waitMsg=this.loadingText);this.form.load(t)},onCancel:function(){this.fireEvent("cancel",this)},onMetaChange:function(n,t){this.removeAll();var r,i,u,f={};this.add(new Ext.Panel({layout:"column",anchor:"100%",border:!1,defaults:function(){return Ext.apply({},t.formConfig||{},{columnWidth:1/this.columnCount,autoHeight:!0,border:!1,hideLabel:!0,layout:"form"})}.createDelegate(this)(),items:function(){for(var n=[],t=0;t<this.columnCount;t++)n.push({defaults:this.defaults,listeners:{add:{scope:this,fn:this.onAdd}}});return n}.createDelegate(this)()}));r=this.items.get(0).items;i=0;u=1;Ext.isArray(this.ignoreFields)&&Ext.each(this.ignoreFields,function(n){f[n]=!0});Ext.each(t.columns||t.fields,function(n){if(!0!==f[n.name]){var e=Ext.apply({},n.editor,{name:n.name||n.dataIndex,fieldLabel:n.fieldLabel||n.header,defaultValue:n.defaultValue,xtype:n.editor&&n.editor.xtype?n.editor.xtype:"textfield"});e.editor&&e.editor.regex&&(e.editor.regex=new RegExp(n.editor.regex));"checkbox"===e.xtype&&Ext.apply(e,{boxLabel:" ",checked:n.defaultValue});t.formConfig.msgTarget&&(e.msgTarget=t.formConfig.msgTarget);e.tabIndex=u++;r.get(i++).add(e);i=i==this.columnCount?0:i}},this);this.doLayout()},onOk:function(){this.updateBoundData();this.fireEvent("ok",this)},onRender:function(){Ext.ux.MetaForm.superclass.onRender.apply(this,arguments);this.form.waitMsgTarget=this.el;!0===this.autoInit?this.load({params:{meta:!0}}):"object"==typeof this.autoInit&&this.load(this.autoInit)},removeAll:function(){var n=this.body.up("div.x-panel-bwrap").prev();n&&n.applyStyles({border:"none"});this.items.each(this.remove,this);this.form.items.clear()},reset:function(){this.form.reset()},setDefaultValues:function(){this.form.items.each(function(n){n.setValue(n.defaultValue)})},submit:function(n){var t=this.getOptions(n);this.savingText&&(t.waitMsg=this.savingText);this.form.submit(t)},updateBoundData:function(){this.data&&Ext.apply(this.data,this.getValues())}});Ext.reg("metaform",Ext.ux.MetaForm)