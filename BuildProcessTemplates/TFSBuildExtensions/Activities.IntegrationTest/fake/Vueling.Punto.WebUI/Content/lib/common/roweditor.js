/*!
 * Ext JS Library 3.1.1
 * Copyright(c) 2006-2010 Ext JS, LLC
 * licensing@extjs.com
 * http://www.extjs.com/license
 */
Ext.ns("Ext.ux.grid");Ext.ux.grid.RowEditor=Ext.extend(Ext.Panel,{floating:!0,shadow:!1,layout:"hbox",cls:"x-small-editor",buttonAlign:"center",baseCls:"x-row-editor",elements:"header,footer,body",frameWidth:5,buttonPad:3,clicksToEdit:"auto",monitorValid:!0,focusDelay:250,errorSummary:!0,saveText:"Save",cancelText:"Cancel",commitChangesText:"You need to commit or cancel your changes",errorText:"Errors",defaults:{normalWidth:!0},initComponent:function(){Ext.ux.grid.RowEditor.superclass.initComponent.call(this);this.addEvents("beforeedit","canceledit","validateedit","afteredit")},init:function(n){if(this.grid=n,this.ownerCt=n,this.clicksToEdit===2)n.on("rowdblclick",this.onRowDblClick,this);else{n.on("rowclick",this.onRowClick,this);if(Ext.isIE)n.on("rowdblclick",this.onRowDblClick,this)}n.getStore().on("remove",function(){this.stopEditing(!1)},this);n.on({scope:this,keydown:this.onGridKey,columnresize:this.verifyLayout,columnmove:this.refreshFields,reconfigure:this.refreshFields,beforedestroy:this.beforedestroy,destroy:this.destroy,bodyscroll:{buffer:250,fn:this.positionButtons}});n.getColumnModel().on("hiddenchange",this.verifyLayout,this,{delay:1});n.getView().on("refresh",this.stopEditing.createDelegate(this,[]))},beforedestroy:function(){this.grid.getStore().un("remove",this.onStoreRemove,this);this.stopEditing(!1);Ext.destroy(this.btns)},refreshFields:function(){this.initFields();this.verifyLayout()},isDirty:function(){var n;return this.items.each(function(t){if(String(this.values[t.id])!==String(t.getValue()))return n=!0,!1},this),n},startEditing:function(n,t){var c,e,l,o,r,i,a;if(this.editing&&this.isDirty()){this.showTooltip(this.commitChangesText);return}if(Ext.isObject(n)&&(n=this.grid.getStore().indexOf(n)),this.fireEvent("beforeedit",this,n)!==!1){this.editing=!0;var u=this.grid,s=u.getView(),f=s.getRow(n),h=u.store.getAt(n);for(this.record=h,this.rowIndex=n,this.values={},this.rendered||this.render(s.getEditorParent()),c=Ext.fly(f).getWidth(),this.setSize(c),this.initialized||this.initFields(),e=u.getColumnModel(),l=this.items.items,i=0,a=e.getColumnCount();i<a;i++)r=this.preEditValue(h,e.getDataIndex(i)),o=l[i],o.setValue(r),this.values[o.id]=Ext.isEmpty(r)?"":r;this.verifyLayout(!0);this.isVisible()?this.el.setXY(Ext.fly(f).getXY(),{duration:.15}):this.setPagePosition(Ext.fly(f).getXY());this.isVisible()||this.show().doLayout();t!==!1&&this.doFocus.defer(this.focusDelay,this)}},stopEditing:function(n){var i,h,r,e,o;if(this.editing=!1,this.isVisible()){if(n===!1||!this.isValid()){this.hide();this.fireEvent("canceledit",this,n===!1);return}var u={},t=this.record,s=!1,f=this.grid.colModel,c=this.items.items;for(i=0,h=f.getColumnCount();i<h;i++)f.isHidden(i)||(r=f.getDataIndex(i),Ext.isEmpty(r)||(e=t.data[r],o=this.postEditValue(c[i].getValue(),e,t,r),String(e)!==String(o)&&(u[r]=o,s=!0)));s&&this.fireEvent("validateedit",this,u,t,this.rowIndex)!==!1&&(t.beginEdit(),Ext.iterate(u,function(n,i){t.set(n,i)}),t.endEdit(),this.fireEvent("afteredit",this,u,t,this.rowIndex));this.hide()}},verifyLayout:function(n){var u,i,r,t,f,e;if(this.el&&(this.isVisible()||n===!0)){for(u=this.grid.getView().getRow(this.rowIndex),this.setSize(Ext.fly(u).getWidth(),Ext.isIE?Ext.fly(u).getHeight()+9:undefined),i=this.grid.colModel,r=this.items.items,t=0,f=i.getColumnCount();t<f;t++)i.isHidden(t)?r[t].hide():(e=0,e+=t===f-1?3:1,r[t].show(),r[t].setWidth(i.getColumnWidth(t)-e));this.doLayout();this.positionButtons()}},slideHide:function(){this.hide()},initFields:function(){var r=this.grid.getColumnModel(),u=Ext.layout.ContainerLayout.prototype.parseMargins,t,f,i,n;for(this.removeAll(!1),t=0,f=r.getColumnCount();t<f;t++){if(i=r.getColumnAt(t),n=i.getEditor(),n=n?n.field:i.displayEditor||new Ext.form.DisplayField,n.margins=t==0?u("0 1 2 1"):t==f-1?u("0 0 2 1"):u("0 1 2"),n.setWidth(r.getColumnWidth(t)),n.column=i,n.ownerCt!==this){n.on("focus",this.ensureVisible,this);n.on("specialkey",this.onKey,this)}this.insert(t,n)}this.initialized=!0},onKey:function(n,t){t.getKey()===t.ENTER&&(this.stopEditing(!0),t.stopPropagation())},onGridKey:function(n){var t,i;n.getKey()!==n.ENTER||this.isVisible()||(t=this.grid.getSelectionModel().getSelected(),t&&(i=this.grid.store.indexOf(t),this.startEditing(i),n.stopPropagation()))},ensureVisible:function(n){this.isVisible()&&this.grid.getView().ensureVisible(this.rowIndex,this.grid.colModel.getIndexById(n.column.id),!0)},onRowClick:function(n,t,i){if(this.clicksToEdit=="auto"){var r=this.lastClickIndex;if(this.lastClickIndex=t,r!=t&&!this.isVisible())return}this.startEditing(t,!1);this.doFocus.defer(this.focusDelay,this,[i.getPoint()])},onRowDblClick:function(n,t,i){this.startEditing(t,!1);this.doFocus.defer(this.focusDelay,this,[i.getPoint()])},onRender:function(){Ext.ux.grid.RowEditor.superclass.onRender.apply(this,arguments);this.el.swallowEvent(["keydown","keyup","keypress"]);this.btns=new Ext.Panel({baseCls:"x-plain",cls:"x-btns",elements:"body",layout:"table",width:this.minButtonWidth*2+this.frameWidth*2+this.buttonPad*4,items:[{ref:"saveBtn",itemId:"saveBtn",xtype:"button",text:this.saveText,width:this.minButtonWidth,handler:this.stopEditing.createDelegate(this,[!0])},{xtype:"button",text:this.cancelText,width:this.minButtonWidth,handler:this.stopEditing.createDelegate(this,[!1])}]});this.btns.render(this.bwrap)},afterRender:function(){Ext.ux.grid.RowEditor.superclass.afterRender.apply(this,arguments);this.positionButtons();this.monitorValid&&this.startMonitoring()},onShow:function(){this.monitorValid&&this.startMonitoring();Ext.ux.grid.RowEditor.superclass.onShow.apply(this,arguments)},onHide:function(){Ext.ux.grid.RowEditor.superclass.onHide.apply(this,arguments);this.stopMonitoring();this.grid.getView().focusRow(this.rowIndex)},positionButtons:function(){if(this.btns){var n=this.grid,t=this.el.dom.clientHeight,i=n.getView(),r=i.scroller.dom.scrollLeft,u=this.btns.getWidth(),f=Math.min(n.getWidth(),n.getColumnModel().getTotalWidth());this.btns.el.shift({left:f/2-u/2+r,top:t-2,stopFx:!0,duration:.2})}},preEditValue:function(n,t){var i=n.data[t];return this.autoEncode&&typeof i=="string"?Ext.util.Format.htmlDecode(i):i},postEditValue:function(n){return this.autoEncode&&typeof n=="string"?Ext.util.Format.htmlEncode(n):n},doFocus:function(n){var i,r,u,f,t,e;if(this.isVisible())for(i=0,r=this.grid.getColumnModel(),n&&(i=this.getTargetColumnIndex(n)),t=i||0,e=r.getColumnCount();t<e;t++)if(u=r.getColumnAt(t),f=u.getEditor(),!u.hidden&&f){f.field.focus();break}},getTargetColumnIndex:function(n){for(var i=this.grid,e=i.view,o=n.left,r=i.colModel.config,t=0,u=!1,s=r.length,f;f=r[t];t++)if(!f.hidden&&Ext.fly(e.getHeaderCell(t)).getRegion().right>=o){u=t;break}return u},startMonitoring:function(){!this.bound&&this.monitorValid&&(this.bound=!0,Ext.TaskMgr.start({run:this.bindHandler,interval:this.monitorPoll||200,scope:this}))},stopMonitoring:function(){this.bound=!1;this.tooltip&&this.tooltip.hide()},isValid:function(){var n=!0;return this.items.each(function(t){if(!t.isValid(!0))return n=!1,!1}),n},bindHandler:function(){if(!this.bound)return!1;var n=this.isValid();!n&&this.errorSummary&&this.showTooltip(this.getErrorText().join(""));this.btns.saveBtn.setDisabled(!n);this.fireEvent("validation",this,n)},showTooltip:function(n){var t=this.tooltip;t||(t=this.tooltip=new Ext.ToolTip({maxWidth:600,cls:"errorTip",width:300,title:this.errorText,autoHide:!1,anchor:"left",anchorToTarget:!0,mouseOffset:[40,0]}));var i=this.grid.getView(),r=parseInt(this.el.dom.style.top,10),u=i.scroller.dom.scrollTop,f=this.el.getHeight();r+f>=u?(t.initTarget(this.items.last().getEl()),t.rendered||(t.show(),t.hide()),t.body.update(n),t.doAutoWidth(20),t.show()):t.rendered&&t.hide()},getErrorText:function(){var n=["<ul>"];return this.items.each(function(t){t.isValid(!0)||n.push("<li>",t.getActiveError(),"<\/li>")}),n.push("<\/ul>"),n}});Ext.preg&&Ext.preg("roweditor",Ext.ux.grid.RowEditor)